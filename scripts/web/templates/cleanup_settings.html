{% extends "base.html" %}

{% block title %}Cleanup Settings - Tesla USB Gadget Control{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cleanup.css') }}?v=20251108">
{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/cleanup.css') }}?v=20251108">

<div class="container">
    <div class="page-header">
        <a href="{{ url_for('analytics.dashboard') }}" class="btn btn-back">‚Üê Back to Analytics</a>
        <h2>üßπ Auto-Cleanup Settings</h2>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    {% if mode != 'edit' %}
        <div class="alert alert-warning">
            <strong>‚ö†Ô∏è Edit Mode Required</strong><br>
            You must be in Edit mode to configure and run cleanup. 
            <a href="{{ url_for('mode_control.index') }}">Switch to Edit mode</a>
        </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('cleanup.save_settings') }}" class="cleanup-form">
        <!-- Dynamic folder settings based on detected folders -->
        {% for folder_name, policy in policies.items() %}
        <div class="cleanup-card folder-card">
            <div class="folder-header">
                <h2>
                    {% if folder_name == 'RecentClips' %}üöó
                    {% elif folder_name == 'SavedClips' %}‚≠ê
                    {% elif folder_name == 'SentryClips' %}üö®
                    {% elif folder_name == 'EncryptedClips' %}üîí
                    {% else %}üìÅ
                    {% endif %}
                    {{ folder_name }}
                </h2>
                <label class="toggle-switch">
                    <input type="checkbox" name="{{ folder_name }}_enabled" 
                           {% if policy['enabled'] %}checked{% endif %}
                           {% if mode != 'edit' %}disabled{% endif %}>
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">
                        Run cleanup on boot
                        {% if folder_name in ['SavedClips', 'SentryClips', 'EncryptedClips'] %}
                        (‚ö†Ô∏è Not recommended)
                        {% endif %}
                    </span>
                </label>
            </div>
            
            <div class="policy-options">
                <div class="policy-option">
                    <label class="checkbox-label">
                        <input type="checkbox" name="{{ folder_name }}_age_enabled"
                               {% if policy['age_based']['enabled'] %}checked{% endif %}
                               {% if mode != 'edit' %}disabled{% endif %}>
                        Age-based: Delete videos older than
                    </label>
                    <input type="number" name="{{ folder_name }}_age_days" 
                           value="{{ policy['age_based']['days'] }}" 
                           min="1" max="3650" class="number-input"
                           {% if mode != 'edit' %}disabled{% endif %}> days
                </div>
                
                {% if 'size_based' in policy %}
                <div class="policy-option">
                    <label class="checkbox-label">
                        <input type="checkbox" name="{{ folder_name }}_size_enabled"
                               {% if policy['size_based']['enabled'] %}checked{% endif %}
                               {% if mode != 'edit' %}disabled{% endif %}>
                        Size-based: Keep maximum of
                    </label>
                    <input type="number" name="{{ folder_name }}_size_gb" 
                           value="{{ policy['size_based']['max_gb'] }}" 
                           min="1" max="1000" class="number-input"
                           {% if mode != 'edit' %}disabled{% endif %}> GB
                </div>
                {% endif %}
                
                {% if 'count_based' in policy %}
                <div class="policy-option">
                    <label class="checkbox-label">
                        <input type="checkbox" name="{{ folder_name }}_count_enabled"
                               {% if policy['count_based']['enabled'] %}checked{% endif %}
                               {% if mode != 'edit' %}disabled{% endif %}>
                        Count-based: Keep only newest
                    </label>
                    <input type="number" name="{{ folder_name }}_count_videos" 
                           value="{{ policy['count_based']['max_videos'] }}" 
                           min="1" max="10000" class="number-input"
                           {% if mode != 'edit' %}disabled{% endif %}> videos
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
        
        <!-- Action Buttons -->
        <div class="button-group">
            <button type="submit" class="btn btn-primary" {% if mode != 'edit' %}disabled{% endif %}>üíæ Save Settings</button>
            <a href="{{ url_for('cleanup.preview') }}" class="btn btn-secondary {% if mode != 'edit' %}disabled{% endif %}">üîç Preview Cleanup</a>
        </div>
    </form>
    
    <!-- Help Card -->
    <div class="cleanup-card help-card">
        <h3>‚ÑπÔ∏è How Auto-Cleanup Works</h3>
        <ul>
            <li><strong>Manual Cleanup:</strong> Use "Preview Cleanup" to see what will be deleted, then choose to execute. This works regardless of the "Run cleanup on boot" setting.</li>
            <li><strong>Automatic Cleanup:</strong> When "Run cleanup on boot" is enabled for a folder, the system will automatically delete matching files during the boot sequence, before presenting the USB drive to Tesla.</li>
            <li><strong>RecentClips:</strong> Normal dashcam footage - safe to auto-delete after a period</li>
            <li><strong>SavedClips:</strong> Videos you manually saved - disabled by default to protect important clips</li>
            <li><strong>SentryClips:</strong> Security event recordings - disabled by default for safety</li>
            <li><strong>EncryptedClips:</strong> Cybertruck encrypted footage - disabled by default</li>
            <li><strong>Protected videos:</strong> Videos from the past hour are never deleted (might still be recording)</li>
            <li><strong>Boot sequence:</strong> On startup, the system mounts partitions read-write, runs cleanup for enabled folders, then unmounts and presents the USB gadget to Tesla</li>
        </ul>
    </div>
</div>
{% endblock %}
