{% extends "base.html" %}
{% block content %}
<div class="container">
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Switching modes, please wait...</div>
    </div>
    
    <div id="apLoadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">Updating AP settings, please wait...</div>
    </div>
    
    <form method="post" action="{{url_for('mode_control.present_usb')}}" id="presentForm" style="display: inline;">
        <button type="submit" class="present-btn" id="presentBtn">üì± Present USB Gadget</button>
    </form>
    
    <form method="post" action="{{url_for('mode_control.edit_usb')}}" id="editForm" style="display: inline;">
        <button type="submit" class="edit-btn" id="editBtn">üìÅ Edit USB (mount + Samba)</button>
    </form>
    
    <div class="info-box">
        <strong>Present USB Mode:</strong> Pi appears as USB storage to Tesla. Files are accessible in read-only mode locally.<br>
        <strong>Edit USB Mode:</strong> Partitions mounted locally with Samba access for full read-write access.
    </div>

    {% if share_paths %}
    <div class="shares">
        <strong>Network Shares:</strong>
        <ul>
            {% for path in share_paths %}
            <li><code>{{ path }}</code></li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="info-box" style="margin-top: 20px;">
        <strong>Fallback Access Point:</strong><br>
        {% if ap_status.error %}
            <div style="color: #c00;">AP status unavailable ({{ ap_status.error }})</div>
        {% else %}
            <div>Status: {{ 'Active' if ap_status.ap_active else 'Inactive' }} | Mode: {{ 'AP On' if ap_status.force_mode == 'force_on' else 'Auto' }}</div>
            <div>SSID: <code>{{ ap_status.ssid }}</code> | IP: <code>{{ ap_status.static_ip }}</code> | DHCP: <code>{{ ap_status.dhcp_range_start }} - {{ ap_status.dhcp_range_end }}</code></div>
            {% if ap_status.allow_concurrent %}
                <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 4px;">The AP runs on a virtual interface, allowing simultaneous WiFi and AP access.</div>
            {% endif %}
            
            <div style="margin-top: 12px; padding: 10px; background-color: var(--bg-info); border: 1px solid var(--border-color); border-radius: 4px;">
                <strong style="color: var(--text-primary);">AP Configuration:</strong>
                <form method="post" action="{{ url_for('mode_control.configure_ap') }}" id="apConfigForm" style="margin-top: 8px;">
                    <div style="margin-bottom: 8px;">
                        <label for="ap_ssid" style="display: inline-block; width: 100px; color: var(--text-primary);">SSID:</label>
                        <input type="text" id="ap_ssid" name="ssid" value="{{ ap_config.ssid }}" maxlength="32" required 
                               style="width: 200px; padding: 4px; background-color: var(--form-input-bg); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 3px;">
                        <span style="font-size: 0.85em; color: var(--text-secondary);">(1-32 chars)</span>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <label for="ap_passphrase" style="display: inline-block; width: 100px; color: var(--text-primary);">Password:</label>
                        <input type="password" id="ap_passphrase" name="passphrase" value="{{ ap_config.passphrase }}" minlength="8" maxlength="63" 
                               style="width: 200px; padding: 4px; background-color: var(--form-input-bg); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 3px;">
                        <button type="button" onclick="togglePassword()" style="padding: 4px 8px; margin-left: 4px; background-color: var(--btn-info-bg); color: var(--btn-info-text); border: none; border-radius: 3px; cursor: pointer;">Show</button>
                        <span style="font-size: 0.85em; color: var(--text-secondary);">(8-63 chars)</span>
                    </div>
                    <button type="submit" class="edit-btn" id="updateApBtn" onclick="return confirm('Changing AP credentials will disconnect all connected clients. Continue?')">Update AP Credentials</button>
                </form>
            </div>
            
            <div style="margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap;">
                <form method="post" action="{{ url_for('mode_control.force_ap') }}" id="startApForm" style="margin: 0;">
                    <input type="hidden" name="mode" value="on">
                    <button type="submit" class="edit-btn" id="startApBtn">Start AP Now</button>
                </form>
                <form method="post" action="{{ url_for('mode_control.force_ap') }}" id="stopApForm" style="margin: 0;">
                    <input type="hidden" name="mode" value="off">
                    <button type="submit" class="present-btn" id="stopApBtn">Stop AP</button>
                </form>
            </div>
            <div style="margin-top:6px; font-size: 0.95em; color: var(--text-secondary);">
                <strong>Auto mode:</strong> AP automatically starts when WiFi is unavailable and stops when WiFi is restored.<br>
                <strong>AP On mode:</strong> AP stays on continuously regardless of WiFi status (activated by "Start AP Now" button).
            </div>
        {% endif %}
    </div>
    
    <div class="info-box" style="margin-top: 20px;">
        <strong>WiFi Client Configuration:</strong><br>
        <div style="margin-bottom: 8px;">
            {% if wifi_status.connected %}
                <span style="color: var(--success-color);">‚úì Connected to: <code>{{ wifi_status.current_ssid }}</code></span>
                {% if wifi_status.signal and wifi_status.signal != 'Unknown' %}
                    <span style="margin-left: 8px; font-size: 0.9em; color: var(--text-secondary);">(Signal: {{ wifi_status.signal }}%)</span>
                {% endif %}
            {% else %}
                <span style="color: var(--warning-color);">‚ö† Not connected to WiFi</span>
            {% endif %}
        </div>
        
        <div style="margin-top: 12px; padding: 10px; background-color: var(--bg-info); border: 1px solid var(--border-color); border-radius: 4px;">
            <strong style="color: var(--text-primary);">Update WiFi Credentials:</strong>
            <form method="post" action="{{ url_for('mode_control.configure_wifi') }}" id="wifiConfigForm" style="margin-top: 8px;">
                <div style="margin-bottom: 8px;">
                    <label for="wifi_ssid" style="display: inline-block; width: 120px; color: var(--text-primary);">Network Name:</label>
                    <input type="text" id="wifi_ssid" name="wifi_ssid" maxlength="32" required 
                           placeholder="Enter WiFi SSID"
                           style="width: 200px; padding: 4px; background-color: var(--form-input-bg); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 3px;">
                    <span style="font-size: 0.85em; color: var(--text-secondary);">(1-32 chars)</span>
                </div>
                <div style="margin-bottom: 8px;">
                    <label for="wifi_password" style="display: inline-block; width: 120px; color: var(--text-primary);">Password:</label>
                    <input type="password" id="wifi_password" name="wifi_password" minlength="8" maxlength="63"
                           placeholder="Enter WiFi password"
                           style="width: 200px; padding: 4px; background-color: var(--form-input-bg); color: var(--text-primary); border: 1px solid var(--border-input); border-radius: 3px;">
                    <button type="button" onclick="toggleWifiPassword()" style="padding: 4px 8px; margin-left: 4px; background-color: var(--btn-info-bg); color: var(--btn-info-text); border: none; border-radius: 3px; cursor: pointer;">Show</button>
                    <span style="font-size: 0.85em; color: var(--text-secondary);">(8-63 chars)</span>
                </div>
                <button type="submit" class="edit-btn" id="updateWifiBtn" onclick="return confirmWifiUpdate()">Update WiFi Credentials</button>
            </form>
        </div>
        
        <div style="margin-top: 8px; font-size: 0.9em; color: var(--text-secondary);">
            <strong>‚ÑπÔ∏è How it works:</strong> The Pi will attempt to connect to the new network. Thanks to concurrent AP mode, you can remain connected to the fallback AP during the transition. If the new WiFi network is unreachable or credentials are incorrect, you'll maintain access via the AP.
        </div>
    </div>
</div>

<script>
function togglePassword() {
    const passField = document.getElementById('ap_passphrase');
    const btn = event.target;
    if (passField.type === 'password') {
        passField.type = 'text';
        btn.textContent = 'Hide';
    } else {
        passField.type = 'password';
        btn.textContent = 'Show';
    }
}

function toggleWifiPassword() {
    const passField = document.getElementById('wifi_password');
    const btn = event.target;
    if (passField.type === 'password') {
        passField.type = 'text';
        btn.textContent = 'Hide';
    } else {
        passField.type = 'password';
        btn.textContent = 'Show';
    }
}

function confirmWifiUpdate() {
    // Check if user is currently connected via WiFi (not AP)
    const connectedViaWifi = {{ 'true' if wifi_status.connected else 'false' }};
    const currentSSID = {{ ('\"' + wifi_status.current_ssid + '\"') if wifi_status.get('current_ssid') else 'null' }};
    const apActive = {{ 'true' if ap_status.ap_active else 'false' }};
    const apIP = {{ ('\"' + ap_status.static_ip + '\"') if ap_status.get('static_ip') else 'null' }};
    
    // Detect if user is accessing via AP IP
    const accessingViaAP = apIP && (window.location.hostname === apIP || window.location.hostname === apIP.split('/')[0]);
    
    let message = '';
    
    if (connectedViaWifi && !accessingViaAP && currentSSID) {
        // User is connected via WiFi directly (not through AP)
        message = '‚ö†Ô∏è WARNING: You are currently connected via WiFi (network: ' + currentSSID + ').\n\n';
        message += 'If you change the WiFi credentials and they are incorrect, you will lose this connection.\n\n';
        message += 'HOWEVER: The fallback AP is ' + (apActive ? 'already running' : 'available') + '.\n';
        message += 'If the new WiFi fails, you can reconnect to the AP to fix it.\n\n';
        message += 'Recommended: Connect to the AP first for safer credential updates.\n\n';
        message += 'Continue anyway?';
    } else if (accessingViaAP || apActive) {
        // User is accessing via AP - safe!
        message = '‚úì You are connected via the fallback AP.\n\n';
        message += 'The Pi will attempt to connect to the new WiFi network.\n';
        message += 'Your AP connection will remain active during the process.\n\n';
        message += 'Continue?';
    } else {
        // Not sure how they're connected - generic warning
        message = 'The Pi will attempt to connect to the new WiFi network.\n';
        message += 'The fallback AP will remain available if connection fails.\n\n';
        message += 'Continue?';
    }
    
    return confirm(message);
}

// Prevent multiple mode switch submissions
const presentForm = document.getElementById('presentForm');
const editForm = document.getElementById('editForm');
const presentBtn = document.getElementById('presentBtn');
const editBtn = document.getElementById('editBtn');
const loadingOverlay = document.getElementById('loadingOverlay');

// AP form elements
const apConfigForm = document.getElementById('apConfigForm');
const startApForm = document.getElementById('startApForm');
const stopApForm = document.getElementById('stopApForm');
const updateApBtn = document.getElementById('updateApBtn');
const startApBtn = document.getElementById('startApBtn');
const stopApBtn = document.getElementById('stopApBtn');
const apLoadingOverlay = document.getElementById('apLoadingOverlay');

// WiFi form elements
const wifiConfigForm = document.getElementById('wifiConfigForm');
const updateWifiBtn = document.getElementById('updateWifiBtn');

function disableButtons() {
    presentBtn.disabled = true;
    editBtn.disabled = true;
    presentBtn.style.opacity = '0.5';
    editBtn.style.opacity = '0.5';
    presentBtn.style.cursor = 'not-allowed';
    editBtn.style.cursor = 'not-allowed';
    loadingOverlay.style.display = 'flex';
}

function disableApButtons() {
    updateApBtn.disabled = true;
    startApBtn.disabled = true;
    stopApBtn.disabled = true;
    updateApBtn.style.opacity = '0.5';
    startApBtn.style.opacity = '0.5';
    stopApBtn.style.opacity = '0.5';
    updateApBtn.style.cursor = 'not-allowed';
    startApBtn.style.cursor = 'not-allowed';
    stopApBtn.style.cursor = 'not-allowed';
    apLoadingOverlay.style.display = 'flex';
}

presentForm.addEventListener('submit', function(e) {
    if (presentBtn.disabled) {
        e.preventDefault();
        return false;
    }
    disableButtons();
});

editForm.addEventListener('submit', function(e) {
    if (editBtn.disabled) {
        e.preventDefault();
        return false;
    }
    disableButtons();
});

apConfigForm.addEventListener('submit', function(e) {
    if (updateApBtn.disabled) {
        e.preventDefault();
        return false;
    }
    disableApButtons();
});

startApForm.addEventListener('submit', function(e) {
    if (startApBtn.disabled) {
        e.preventDefault();
        return false;
    }
    disableApButtons();
});

stopApForm.addEventListener('submit', function(e) {
    if (stopApBtn.disabled) {
        e.preventDefault();
        return false;
    }
    disableApButtons();
});

wifiConfigForm.addEventListener('submit', function(e) {
    if (updateWifiBtn.disabled) {
        e.preventDefault();
        return false;
    }
    updateWifiBtn.disabled = true;
    updateWifiBtn.style.opacity = '0.5';
    updateWifiBtn.style.cursor = 'not-allowed';
    updateWifiBtn.textContent = 'Connecting...';
});
</script>
{% endblock %}
