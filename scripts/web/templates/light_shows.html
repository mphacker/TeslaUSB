{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üí° Light Shows</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    <!-- iOS Safari Warning -->
    <div id="iosWarning" style="display: none; background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è iOS Browser Limitation:</strong> File uploading is only available through Safari when running on iOS. Please open this page in Safari to upload files.</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: var(--text-secondary);">Note: Desktop browsers (Windows/Mac/Linux) work normally regardless of browser choice.</p>
    </div>
    
    <div class="folder-controls" id="showUploadControls">
        <form method="post" action="{{ url_for('light_shows.upload_light_show') }}" enctype="multipart/form-data" style="margin-bottom: 20px;" id="showUploadForm">
            <label for="show_file" style="display: block; margin-bottom: 8px; font-weight: 600;">Upload Light Show File or ZIP:</label>
            <p style="margin: 0 0 10px 0; font-size: 13px; color: var(--text-secondary);">
                Individual files: .fseq, .mp3, .wav<br>
                ZIP files: Can contain multiple light show files in any folder structure
            </p>
            <input type="file" name="show_file" id="show_file" accept=".fseq,.mp3,.wav,.zip" required 
                   style="display: block; margin-bottom: 10px; padding: 10px; border: 2px solid var(--border-input); border-radius: 4px; background: var(--form-input-bg); width: 100%; max-width: 400px; font-size: 14px; color: var(--text-primary);">
            <button type="submit" class="edit-btn" id="showUploadBtn">üì§ Upload</button>
        </form>
        <!-- Upload Progress Bar -->
        <div id="showUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="background: var(--upload-progress-bg); border-radius: 8px; padding: 15px; border: 2px solid var(--btn-purple-bg);">
                <h4 style="margin: 0 0 10px 0; color: var(--btn-purple-bg);">üì§ Uploading Light Show...</h4>
                <div style="background: var(--upload-progress-bar-bg); border-radius: 4px; height: 30px; overflow: hidden; margin-bottom: 10px;">
                    <div id="showProgressBar" style="background: linear-gradient(90deg, #6f42c1, #5a32a3); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        0%
                    </div>
                </div>
                <p id="showUploadStatus" style="margin: 0; font-size: 13px; color: var(--text-secondary);">Preparing upload...</p>
            </div>
        </div>
    </div>
    
    {% if show_groups %}
    <div class="video-table-container">
        <table class="video-table" style="table-layout: fixed;">
            <thead>
                <tr>
                    <th style="width: 25%;">Show Name</th>
                    <th style="width: 45%;">Files</th>
                    <th style="width: 30%;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for group in show_groups %}
                <tr>
                    <td style="word-wrap: break-word; overflow-wrap: break-word;">{{ group.base_name }}</td>
                    <td style="word-wrap: break-word; overflow-wrap: break-word; font-size: 0.9em;">
                        {% if group.fseq_file %}
                        <div style="margin-bottom: 5px;">
                            <strong>FSEQ:</strong> {{ group.fseq_file.filename }} ({{ group.fseq_file.size_str }})
                        </div>
                        {% endif %}
                        {% if group.audio_file %}
                        <div>
                            <strong>Audio:</strong> {{ group.audio_file.filename }} ({{ group.audio_file.size_str }})
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        {% if group.audio_file %}
                        <div style="margin-bottom: 8px;">
                            <audio controls preload="none" style="width: 100%; max-width: 200px; height: 30px;">
                                {% if group.audio_file.filename.lower().endswith('.mp3') %}
                                <source src="{{ url_for('light_shows.play_light_show_audio', partition=group.partition_key, filename=group.audio_file.filename) }}" type="audio/mpeg">
                                {% else %}
                                <source src="{{ url_for('light_shows.play_light_show_audio', partition=group.partition_key, filename=group.audio_file.filename) }}" type="audio/wav">
                                {% endif %}
                            </audio>
                        </div>
                        {% endif %}
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <a href="{{ url_for('light_shows.download_light_show', partition=group.partition_key, base_name=group.base_name) }}" 
                               class="edit-btn" style="text-decoration: none; display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; font-size: 14px; border-radius: 4px;">
                                üì• Download ZIP
                            </a>
                            <form method="post" action="{{ url_for('light_shows.delete_light_show', partition=group.partition_key, base_name=group.base_name) }}" style="display: inline-block; margin: 0;" 
                                  onsubmit="return confirm('Are you sure you want to delete all files for {{ group.base_name }}?');">
                                <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Card Layout for Light Shows -->
    <div class="mobile-card-container">
        {% for group in show_groups %}
        <div class="mobile-card">
            <div class="mobile-card-title">
                <strong>{{ group.base_name }}</strong>
            </div>
            <div class="mobile-card-info">
                {% if group.fseq_file %}
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">FSEQ:</span>
                    <span class="mobile-card-info-value" style="font-size: 12px; word-break: break-word;">
                        {{ group.fseq_file.filename }}<br>
                        ({{ group.fseq_file.size_str }})
                    </span>
                </div>
                {% endif %}
                {% if group.audio_file %}
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Audio:</span>
                    <span class="mobile-card-info-value" style="font-size: 12px; word-break: break-word;">
                        {{ group.audio_file.filename }}<br>
                        ({{ group.audio_file.size_str }})
                    </span>
                </div>
                {% endif %}
            </div>
            {% if group.audio_file %}
            <div class="mobile-card-audio">
                <audio controls preload="none">
                    {% if group.audio_file.filename.lower().endswith('.mp3') %}
                    <source src="{{ url_for('light_shows.play_light_show_audio', partition=group.partition_key, filename=group.audio_file.filename) }}" type="audio/mpeg">
                    {% else %}
                    <source src="{{ url_for('light_shows.play_light_show_audio', partition=group.partition_key, filename=group.audio_file.filename) }}" type="audio/wav">
                    {% endif %}
                </audio>
            </div>
            {% endif %}
            <div class="mobile-card-actions" style="display: flex; gap: 8px; flex-wrap: wrap; align-items: stretch;">
                <a href="{{ url_for('light_shows.download_light_show', partition=group.partition_key, base_name=group.base_name) }}" 
                   class="edit-btn" style="text-decoration: none; display: flex; align-items: center; justify-content: center; flex: 1; padding: 6px 12px; border-radius: 4px;">
                    üì• Download
                </a>
                <form method="post" action="{{ url_for('light_shows.delete_light_show', partition=group.partition_key, base_name=group.base_name) }}" 
                      onsubmit="return confirm('Are you sure you want to delete all files for {{ group.base_name }}?');"
                      style="flex: 1; margin: 0;">
                    <button type="submit" class="btn-delete" style="width: 100%; height: 100%;">üóëÔ∏è Delete</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="info-box">
        <p>No light show files found in the LightShow folders.</p>
    </div>
    {% endif %}
</div>

<script>
// Handle light show upload with progress bar
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('showUploadForm');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('show_file');
        const uploadBtn = document.getElementById('showUploadBtn');
        const progressDiv = document.getElementById('showUploadProgress');
        const progressBar = document.getElementById('showProgressBar');
        const statusText = document.getElementById('showUploadStatus');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to upload');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData(form);
        
        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚è≥ Uploading...';
        progressDiv.style.display = 'block';
        
        // Create AJAX request with progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                
                // Format file size display
                const loadedKB = (e.loaded / 1024).toFixed(1);
                const totalKB = (e.total / 1024).toFixed(1);
                const loadedMB = (e.loaded / 1024 / 1024).toFixed(2);
                const totalMB = (e.total / 1024 / 1024).toFixed(2);
                
                if (e.total > 1024 * 1024) {
                    statusText.textContent = `Uploading ${file.name}... (${loadedMB} MB / ${totalMB} MB)`;
                } else {
                    statusText.textContent = `Uploading ${file.name}... (${loadedKB} KB / ${totalKB} KB)`;
                }
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
            if (xhr.status === 200 || xhr.status === 302) {
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                progressBar.style.background = '#28a745';
                statusText.textContent = 'Upload complete! Redirecting...';
                statusText.style.color = '#28a745';
                
                // Redirect after short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                progressBar.style.background = '#dc3545';
                statusText.textContent = 'Upload failed: ' + xhr.statusText;
                statusText.style.color = '#dc3545';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload';
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            progressBar.style.background = '#dc3545';
            statusText.textContent = 'Upload failed: Network error';
            statusText.style.color = '#dc3545';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Upload';
        });
        
        // Send the request
        xhr.open('POST', form.action);
        xhr.send(formData);
    });
});

// iOS Browser Detection and Warning Display
(function() {
    // Detect iOS device
    function isIOS() {
        return /(iPad|iPhone|iPod)/i.test(navigator.userAgent) && !window.MSStream;
    }
    
    // Detect Safari (true Safari, not other browsers using WebKit on iOS)
    function isSafari() {
        var ua = navigator.userAgent;
        // Safari should have "Safari" but NOT Chrome, CriOS, EdgiOS, FxiOS, OPiOS
        return /Safari/i.test(ua) && !/Chrome|CriOS|EdgiOS|FxiOS|OPiOS/i.test(ua);
    }
    
    // Show warning and hide controls if iOS + not Safari
    if (isIOS() && !isSafari()) {
        var warning = document.getElementById('iosWarning');
        var controls = document.getElementById('showUploadControls');
        if (warning) warning.style.display = 'block';
        if (controls) controls.style.display = 'none';
    }
})();
</script>
{% endblock %}
