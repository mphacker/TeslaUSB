{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üîî Lock Chimes</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    {% if mode_token == 'edit' %}
    <!-- iOS Safari Warning -->
    <div id="iosWarning" style="display: none; background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è iOS Browser Limitation:</strong> File uploading is only available through Safari when running on iOS. Please open this page in Safari to upload files.</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #666;">Note: Desktop browsers (Windows/Mac/Linux) work normally regardless of browser choice.</p>
    </div>
    
    <div class="folder-controls" id="chimeUploadControls">
        <form method="post" action="{{ url_for('lock_chimes.upload_lock_chime') }}" enctype="multipart/form-data" style="margin-bottom: 20px;" id="chimeUploadForm">
            <label for="chime_file" style="display: block; margin-bottom: 8px; font-weight: 600;">Upload New Chime to Library:</label>
            <div style="display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 10px;">
                <input type="file" name="chime_file" id="chime_file" accept=".wav,.mp3" required 
                       style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; background: white; flex: 1; min-width: 250px; max-width: 400px; font-size: 14px;">
                <button type="submit" class="edit-btn" id="chimeUploadBtn" style="margin: 0;">üì§ Upload</button>
            </div>
            <p style="margin: 0 0 10px 0; font-size: 12px; color: #666;">
                Tesla Requirements: PCM 16-bit, 44.1 kHz, mono/stereo, under 1MB<br>
                Upload WAV or MP3 files - they will be automatically converted and trimmed if needed
            </p>
        </form>
        <!-- Upload Progress Bar -->
        <div id="chimeUploadProgress" style="display: none; margin-bottom: 20px;">
            <div style="background: #f0f0f0; border-radius: 8px; padding: 15px; border: 2px solid #007bff;">
                <h4 style="margin: 0 0 10px 0; color: #007bff;">üì§ Uploading Chime...</h4>
                <div style="background: #e0e0e0; border-radius: 4px; height: 30px; overflow: hidden; margin-bottom: 10px;">
                    <div id="chimeProgressBar" style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                        0%
                    </div>
                </div>
                <p id="chimeUploadStatus" style="margin: 0; font-size: 13px; color: #666;">Preparing upload...</p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Active Lock Chime -->
    {% if active_chime %}
    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <h3 style="margin: 0 0 10px 0; color: #2e7d32;">üîä Active Lock Chime</h3>
        <div style="display: flex; align-items: center; gap: 15px;">
            <div>
                <strong>{{ active_chime.filename }}</strong><br>
                <span style="color: #666; font-size: 13px;">{{ active_chime.size_str }}</span>
            </div>
            <audio controls preload="none" style="flex: 1; max-width: 300px; height: 30px;">
                <source src="{{ url_for('lock_chimes.play_active_chime') }}?v={{ active_chime.mtime }}" type="audio/wav">
            </audio>
        </div>
    </div>
    {% else %}
    <div class="info-box" style="background-color: #ffebee; border-left: 4px solid #f44336; margin-bottom: 20px;">
        <p style="margin: 0;">‚ö†Ô∏è No active lock chime set. Select a chime from the library below.</p>
    </div>
    {% endif %}
    
    <!-- Chime Library -->
    <h3 style="margin: 20px 0 10px 0;">üìö Chime Library</h3>
    {% if chime_files %}
    <div class="video-table-container">
        <table class="video-table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chime in chime_files %}
                <tr style="{% if not chime.is_valid %}background-color: #ffebee;{% endif %}">
                    <td>{{ chime.filename }}</td>
                    <td>{{ chime.size_str }}</td>
                    <td>
                        {% if chime.is_valid %}
                        <span style="color: #4caf50;">‚úì Valid</span>
                        {% else %}
                        <span style="color: #f44336;" title="{{ chime.validation_msg }}">‚úó {{ chime.validation_msg[:30] }}...</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <audio controls preload="none" style="height: 30px; width: 100%; max-width: 300px;">
                                <source src="{{ url_for('lock_chimes.play_lock_chime', filename=chime.filename) }}?v={{ chime.mtime }}" type="audio/wav">
                            </audio>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; align-items: center;">
                                <a href="{{ url_for('lock_chimes.download_lock_chime', filename=chime.filename) }}" class="present-btn" style="text-decoration: none; padding: 6px 12px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; line-height: 1.5; height: 34px; box-sizing: border-box;">‚¨áÔ∏è Download</a>
                                {% if mode_token == 'edit' %}
                                    {% if chime.is_valid %}
                                    <form method="post" action="{{ url_for('lock_chimes.set_as_chime', filename=chime.filename) }}" style="display: inline;" onsubmit="return handleSetChime(this);">
                                        <button type="submit" class="set-chime-btn" style="padding: 6px 12px; margin: 0; font-size: 14px; height: 34px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;">üîî Set as Active</button>
                                    </form>
                                    {% endif %}
                                    <form method="post" action="{{ url_for('lock_chimes.delete_lock_chime', filename=chime.filename) }}" style="display: inline;" 
                                          onsubmit="return confirm('Are you sure you want to delete {{ chime.filename }}?');">
                                        <button type="submit" class="btn-delete" style="padding: 6px 12px; margin: 0; font-size: 14px; height: 34px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;">üóëÔ∏è Delete</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Card Layout for Lock Chimes -->
    <div class="mobile-card-container">
        {% for chime in chime_files %}
        <div class="mobile-card" style="{% if not chime.is_valid %}border-left: 4px solid #f44336;{% endif %}">
            <div class="mobile-card-title">
                <strong>{{ chime.filename }}</strong>
            </div>
            <div class="mobile-card-info">
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Size:</span>
                    <span class="mobile-card-info-value">{{ chime.size_str }}</span>
                </div>
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Status:</span>
                    <span class="mobile-card-info-value">
                        {% if chime.is_valid %}
                        <span class="mobile-card-status valid">‚úì Valid</span>
                        {% else %}
                        <span class="mobile-card-status invalid" title="{{ chime.validation_msg }}">‚úó Invalid</span>
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="mobile-card-audio">
                <audio controls preload="none">
                    <source src="{{ url_for('lock_chimes.play_lock_chime', filename=chime.filename) }}?v={{ chime.mtime }}" type="audio/wav">
                </audio>
            </div>
            <div class="mobile-card-actions">
                <a href="{{ url_for('lock_chimes.download_lock_chime', filename=chime.filename) }}" class="present-btn">‚¨áÔ∏è Download</a>
                {% if mode_token == 'edit' %}
                    {% if chime.is_valid %}
                    <form method="post" action="{{ url_for('lock_chimes.set_as_chime', filename=chime.filename) }}" onsubmit="return handleSetChime(this);">
                        <button type="submit" class="set-chime-btn">üîî Set as Active</button>
                    </form>
                    {% endif %}
                    <form method="post" action="{{ url_for('lock_chimes.delete_lock_chime', filename=chime.filename) }}" 
                          onsubmit="return confirm('Are you sure you want to delete {{ chime.filename }}?');">
                        <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="info-box">
        <p>No chimes found in the Chimes library.</p>
        {% if mode_token == 'edit' %}
        <p>Upload WAV files above to add them to your library.</p>
        {% else %}
        <p>Switch to Edit Mode to upload files.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Loading overlay for Set as Chime operation -->
<div id="chimeLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div style="text-align: center; color: white;">
        <div class="spinner" style="border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <h3>Setting lock chime...</h3>
        <p>Please wait, this may take a few seconds</p>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
function handleSetChime(form) {
    // Disable all Set as Active buttons
    const allChimeButtons = document.querySelectorAll('.set-chime-btn');
    allChimeButtons.forEach(btn => btn.disabled = true);
    
    // Show loading overlay
    document.getElementById('chimeLoadingOverlay').style.display = 'flex';
    
    return true;  // Allow form submission
}

// Handle chime upload with progress bar
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chimeUploadForm');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('chime_file');
        const uploadBtn = document.getElementById('chimeUploadBtn');
        const progressDiv = document.getElementById('chimeUploadProgress');
        const progressBar = document.getElementById('chimeProgressBar');
        const statusText = document.getElementById('chimeUploadStatus');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to upload');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData(form);
        
        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚è≥ Uploading...';
        progressDiv.style.display = 'block';
        
        // Create AJAX request with progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                statusText.textContent = `Uploading ${file.name}... (${(e.loaded / 1024).toFixed(1)} KB / ${(e.total / 1024).toFixed(1)} KB)`;
            }
        });
        
        // When upload finishes, show processing status
        xhr.upload.addEventListener('loadend', function() {
            if (xhr.readyState !== 4) {  // If request not complete yet
                progressBar.style.width = '100%';
                progressBar.textContent = 'üîÑ Processing...';
                progressBar.style.background = '#ffc107';
                statusText.textContent = 'Upload complete! Processing and validating file...';
                statusText.style.color = '#856404';
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
            let response;
            try {
                response = JSON.parse(xhr.responseText);
            } catch (e) {
                response = null;
            }
            
            if (xhr.status === 200 && response && response.success) {
                progressBar.style.width = '100%';
                progressBar.textContent = '‚úì Complete';
                progressBar.style.background = '#28a745';
                
                // Show re-encoding info if present
                let successMsg = 'Upload complete!';
                if (response.reencoded && response.details) {
                    const details = response.details;
                    successMsg = `Upload successful! File was automatically re-encoded to ${details.strategy || 'Tesla format'} (${details.size_mb || '<1'} MB)`;
                }
                
                statusText.textContent = successMsg;
                statusText.style.color = '#28a745';
                
                // Redirect after short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                progressBar.style.background = '#dc3545';
                const errorMsg = response && response.error ? response.error : xhr.statusText || 'Upload failed';
                statusText.textContent = 'Upload failed: ' + errorMsg;
                statusText.style.color = '#dc3545';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload';
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            progressBar.style.background = '#dc3545';
            statusText.textContent = 'Upload failed: Network error';
            statusText.style.color = '#dc3545';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Upload';
        });
        
        // Send the request
        xhr.open('POST', form.action);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Mark as AJAX request
        xhr.send(formData);
    });
});

// iOS Browser Detection and Warning Display
(function() {
    // Detect iOS device
    function isIOS() {
        return /(iPad|iPhone|iPod)/i.test(navigator.userAgent) && !window.MSStream;
    }
    
    // Detect Safari (true Safari, not other browsers using WebKit on iOS)
    function isSafari() {
        var ua = navigator.userAgent;
        // Safari should have "Safari" but NOT Chrome, CriOS, EdgiOS, FxiOS, OPiOS
        return /Safari/i.test(ua) && !/Chrome|CriOS|EdgiOS|FxiOS|OPiOS/i.test(ua);
    }
    
    // Show warning and hide controls if iOS + not Safari
    if (isIOS() && !isSafari()) {
        var warning = document.getElementById('iosWarning');
        var controls = document.getElementById('chimeUploadControls');
        if (warning) warning.style.display = 'block';
        if (controls) controls.style.display = 'none';
    }
})();
</script>
{% endblock %}
