{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üîî Lock Chimes</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    <!-- iOS Safari Warning -->
    <div id="iosWarning" style="display: none; background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
        <p style="margin: 0; font-size: 14px;"><strong>‚ö†Ô∏è iOS Browser Limitation:</strong> File uploading is only available through Safari when running on iOS. Please open this page in Safari to upload files.</p>
        <p style="margin: 8px 0 0 0; font-size: 13px; color: #666;">Note: Desktop browsers (Windows/Mac/Linux) work normally regardless of browser choice.</p>
    </div>
    
    <!-- Active Lock Chime - Moved to top -->
    {% if active_chime %}
    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
        <h3 style="margin: 0 0 10px 0; color: #2e7d32;">üîä Active Lock Chime</h3>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
            <div>
                <strong>{{ active_chime.filename }}</strong><br>
                <span style="color: #666; font-size: 13px;">{{ active_chime.size_str }}</span>
            </div>
            <audio controls preload="none" style="flex: 1; max-width: 300px; height: 30px;">
                <source src="{{ url_for('lock_chimes.play_active_chime') }}?v={{ active_chime.mtime }}" type="audio/wav">
            </audio>
        </div>
    </div>
    {% else %}
    <div class="info-box" style="background-color: #ffebee; border-left: 4px solid #f44336; margin-bottom: 20px;">
        <p style="margin: 0;">‚ö†Ô∏è No active lock chime set. Select a chime from the library below.</p>
    </div>
    {% endif %}
    
    <!-- Upload Controls - Collapsible -->
    <details class="folder-controls" id="chimeUploadControls" style="margin-bottom: 20px;">
        <summary style="cursor: pointer; font-weight: 600; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; color: #1976d2; font-size: 18px; list-style: none; user-select: none;">
            <span style="display: inline-block; margin-right: 5px;">‚ñ∂</span> üì§ Upload New Chime
        </summary>
        
        <div style="background: #f5f5f5; padding: 15px; border-radius: 0 0 8px 8px; border-left: 4px solid #2196f3; border-right: 1px solid #2196f3; border-bottom: 1px solid #2196f3; margin-top: -8px;">
            <form method="post" action="{{ url_for('lock_chimes.upload_lock_chime') }}" enctype="multipart/form-data" id="chimeUploadForm">
                <div style="display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap; margin-bottom: 10px;">
                    <input type="file" name="chime_file" id="chime_file" accept=".wav,.mp3" required 
                           style="padding: 10px; border: 2px solid #ddd; border-radius: 4px; background: white; flex: 1; min-width: 250px; max-width: 400px; font-size: 14px;">
                    <button type="submit" class="edit-btn" id="chimeUploadBtn" style="margin: 0;">üì§ Upload</button>
                </div>
                <p style="margin: 0 0 15px 0; font-size: 12px; color: #666;">
                    WAV or MP3 files - auto-converted to Tesla format (PCM 16-bit, 44.1 kHz, under 1MB)
                </p>
                
                <!-- Volume Normalization Controls -->
                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #ddd;">
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; user-select: none;">
                        <input type="checkbox" id="normalize-on-upload" name="normalize" value="true" checked style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;"> 
                        <span style="font-weight: 600; font-size: 14px;">üîä Normalize volume on upload</span>
                    </label>
                    
                    <div id="normalization-settings">
                        <div class="volume-slider-container" style="margin-bottom: 10px;">
                            <input type="range" id="target-lufs" 
                                   min="0" max="3" value="1" step="1">
                            
                            <div class="slider-labels">
                                <span>Broadcast</span>
                                <span>Streaming</span>
                                <span>Loud</span>
                                <span>Maximum</span>
                            </div>
                        </div>
                        
                        <div class="selected-level">
                            <strong id="current-level">Streaming</strong>
                            <small id="level-description">Recommended for balanced playback</small>
                        </div>
                    </div>
                </div>
            </form>
            
            <!-- Upload Progress Bar -->
            <div id="chimeUploadProgress" style="display: none; margin-top: 15px;">
                <div style="background: #f0f0f0; border-radius: 8px; padding: 15px; border: 2px solid #007bff;">
                    <h4 style="margin: 0 0 10px 0; color: #007bff;">üì§ Uploading Chime...</h4>
                    <div style="background: #e0e0e0; border-radius: 4px; height: 30px; overflow: hidden; margin-bottom: 10px;">
                        <div id="chimeProgressBar" style="background: linear-gradient(90deg, #007bff, #0056b3); height: 100%; width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;">
                            0%
                        </div>
                    </div>
                    <p id="chimeUploadStatus" style="margin: 0; font-size: 13px; color: #666;">Preparing upload...</p>
                </div>
            </div>
        </div>
    </details>
    
    <!-- Chime Scheduler -->
    <details id="scheduler-section" style="margin-bottom: 20px;">
        <summary style="cursor: pointer; font-weight: 600; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3; color: #1976d2; font-size: 18px; list-style: none;">
            <span style="display: inline-block; margin-right: 5px;">‚ñ∂</span> üìÖ Chime Scheduler {% if schedules %}({{ schedules|length }} schedule{{ 's' if schedules|length != 1 else '' }}){% endif %}
        </summary>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 0 0 8px 8px; border-left: 4px solid #2196f3; border-right: 1px solid #2196f3; border-bottom: 1px solid #2196f3; margin-top: -8px;">
            <!-- Add New Schedule Form -->
            <details {% if not schedules %}open{% endif %} style="margin-bottom: 15px;" id="schedule-form-details">
                <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: white; border-radius: 4px; list-style: none;">
                    <span style="display: inline-block; margin-right: 5px;">‚ñ∂</span> <span id="form-title">‚ûï Add New Schedule</span>
                </summary>
            
            <form id="schedule-form" method="post" action="{{ url_for('lock_chimes.add_schedule') }}" style="background: white; padding: 15px; border-radius: 4px; margin-top: 10px;">
                <div style="display: grid; gap: 15px;">
                    <!-- Schedule Name -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Schedule Name:</label>
                        <input type="text" id="schedule-name" name="schedule_name" placeholder="e.g., Morning Chime" required
                               style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box;">
                    </div>
                    
                    <!-- Chime Selection -->
                    <div>
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Chime:</label>
                        <select id="chime-select" name="chime_filename" required
                                style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">-- Select a chime --</option>
                            <option value="RANDOM">üé≤ Random Chime</option>
                            {% for chime in chime_files %}
                                {% if chime.is_valid %}
                                <option value="{{ chime.filename }}">{{ chime.filename }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Schedule Type Selection -->
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Schedule Type:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <label style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; cursor: pointer; user-select: none;">
                                <input type="radio" name="schedule_type" value="weekly" class="schedule-type-radio" checked style="margin-right: 6px;">
                                <span>üìÖ Days of Week</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; cursor: pointer; user-select: none;">
                                <input type="radio" name="schedule_type" value="date" class="schedule-type-radio" style="margin-right: 6px;">
                                <span>üìÜ Specific Date</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; cursor: pointer; user-select: none;">
                                <input type="radio" name="schedule_type" value="holiday" class="schedule-type-radio" style="margin-right: 6px;">
                                <span>üéâ US Holiday</span>
                            </label>
                            <label style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; cursor: pointer; user-select: none;">
                                <input type="radio" name="schedule_type" value="recurring" class="schedule-type-radio" style="margin-right: 6px;">
                                <span>üîÑ Recurring Rotation</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Interval Selection (for recurring schedules) -->
                    <div id="interval-selection" class="schedule-type-field" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Rotation Frequency:</label>
                        <select id="interval-select" name="interval" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">-- Select frequency --</option>
                            {% for interval_value, interval_name in recurring_intervals.items() %}
                            <option value="{{ interval_value }}">{{ interval_name }}</option>
                            {% endfor %}
                        </select>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">
                            ‚ÑπÔ∏è Recurring schedules always use <strong>Random Chime</strong> and automatically avoid repeating the currently active chime
                        </p>
                    </div>
                    
                    <!-- Days Selection (for weekly schedules) -->
                    <div id="days-selection" class="schedule-type-field">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Days:</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            {% for day in ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'] %}
                            <label style="display: flex; align-items: center; padding: 8px 12px; background: #f5f5f5; border-radius: 4px; cursor: pointer; user-select: none;">
                                <input type="checkbox" name="days" value="{{ day }}" class="day-checkbox" id="day-{{ day }}" style="margin-right: 6px;">
                                <span>{{ day[:3] }}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Select at least one day</p>
                    </div>
                    
                    <!-- Date Selection (for date schedules) -->
                    <div id="date-selection" class="schedule-type-field" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Date (Month/Day):</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="month-select" name="month" style="padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select id="day-select" name="day" style="padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="">Day</option>
                                {% for d in range(1, 32) %}
                                <option value="{{ d }}">{{ d }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Chime will play every year on this date</p>
                    </div>
                    
                    <!-- Holiday Selection (for holiday schedules) -->
                    <div id="holiday-selection" class="schedule-type-field" style="display: none;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">Holiday:</label>
                        <select id="holiday-select" name="holiday" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                            <option value="">-- Select a holiday --</option>
                            {% for holiday in holidays %}
                            <option value="{{ holiday.name }}">{{ holiday.name }} ({{ holiday.month }}/{{ holiday.day }})</option>
                            {% endfor %}
                        </select>
                        <p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">Chime will play at 12:00 AM on the holiday</p>
                    </div>
                    
                    <!-- Time Selection (12-hour format) - hidden for holidays -->
                    <div id="time-selection">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Time:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <select id="hour-select" name="hour" required style="padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                                {% for h in range(1, 13) %}
                                <option value="{{ h }}" {% if h == 12 %}selected{% endif %}>{{ h }}</option>
                                {% endfor %}
                            </select>
                            <span style="font-weight: bold;">:</span>
                            <select id="minute-select" name="minute" required style="padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                                {% for m in range(0, 60, 5) %}
                                <option value="{{ '%02d'|format(m) }}" {% if m == 0 %}selected{% endif %}>{{ '%02d'|format(m) }}</option>
                                {% endfor %}
                            </select>
                            <select id="ampm-select" name="am_pm" required style="padding: 8px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;">
                                <option value="AM" id="ampm-am-option" selected>AM</option>
                                <option value="PM" id="ampm-pm-option">PM</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Enable Schedule -->
                    <div>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="enabled-checkbox" name="enabled" value="true" checked style="margin-right: 8px;">
                            <span style="font-weight: 600;">Enable this schedule immediately</span>
                        </label>
                    </div>
                    
                    <!-- Submit Button -->
                    <div>
                        <button type="submit" id="submit-btn" class="edit-btn" style="margin: 0; padding: 12px 25px;">üíæ Save Schedule</button>
                        <button type="button" id="cancel-btn" class="btn-delete" style="margin-left: 10px; display: none; padding: 12px 25px;" onclick="cancelEdit()">‚ùå Cancel</button>
                    </div>
                </div>
            </form>
            </details>
        
        <!-- Existing Schedules List -->
        {% if schedules %}
        <div style="margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0;">Active Schedules:</h4>
            {% for schedule in schedules %}
            <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px; border-left: 4px solid {% if schedule.enabled %}#4caf50{% else %}#999{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1; min-width: 200px;">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            {{ schedule.name }}
                            {% if not schedule.enabled %}
                            <span style="background: #ffc107; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-left: 6px;">DISABLED</span>
                            {% endif %}
                        </div>
                        <div style="font-size: 13px; color: #666;">
                            <div>üîî {% if schedule.chime_filename == 'RANDOM' %}üé≤ Random Chime{% else %}{{ schedule.chime_filename }}{% endif %}</div>
                            <div>‚è∞ {{ format_schedule(schedule) }}</div>
                            {% if schedule.last_run %}
                            <div style="color: #999; font-size: 12px; margin-top: 2px;">
                                üìä Last run: {{ format_last_run(schedule.last_run) }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button type="button" onclick="editSchedule({{ schedule.id }})" class="edit-btn" style="padding: 6px 10px; font-size: 13px; margin: 0;">‚úèÔ∏è Edit</button>
                        <form method="post" action="{{ url_for('lock_chimes.toggle_schedule', schedule_id=schedule.id) }}" style="display: inline;">
                            <button type="submit" class="present-btn" style="padding: 6px 10px; font-size: 13px; margin: 0;">
                                {% if schedule.enabled %}‚è∏Ô∏è Disable{% else %}‚ñ∂Ô∏è Enable{% endif %}
                            </button>
                        </form>
                        <form method="post" action="{{ url_for('lock_chimes.delete_schedule', schedule_id=schedule.id) }}" 
                              style="display: inline;" onsubmit="return confirm('Delete schedule {{ schedule.name }}?');">
                            <button type="submit" class="btn-delete" style="padding: 6px 10px; font-size: 13px; margin: 0;">üóëÔ∏è</button>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="margin: 10px 0 0 0; color: #666; font-size: 14px;">No schedules configured. Add one above to automatically change chimes at specific times.</p>
        {% endif %}
        
        <div style="background: #fff8e1; padding: 10px; border-radius: 4px; margin-top: 15px; font-size: 13px;">
            <strong>‚ÑπÔ∏è How it works:</strong> Schedules run automatically every minute. The most recent schedule for each day will be active. Chimes change without interrupting Tesla recording!
        </div>
        </div>
    </details>
    
    <!-- Chime Library -->
    <h3 style="margin: 20px 0 10px 0;">üìö Chime Library</h3>
    {% if chime_files %}
    <div class="video-table-container">
        <table class="video-table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for chime in chime_files %}
                <tr style="{% if not chime.is_valid %}background-color: #ffebee;{% endif %}">
                    <td>{{ chime.filename }}</td>
                    <td>{{ chime.size_str }}</td>
                    <td>
                        {% if chime.is_valid %}
                        <span style="color: #4caf50;">‚úì Valid</span>
                        {% else %}
                        <span style="color: #f44336;" title="{{ chime.validation_msg }}">‚úó {{ chime.validation_msg[:30] }}...</span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <audio controls preload="none" style="height: 30px; width: 100%; max-width: 300px;">
                                <source src="{{ url_for('lock_chimes.play_lock_chime', filename=chime.filename) }}?v={{ chime.mtime }}" type="audio/wav">
                            </audio>
                            <div style="display: flex; gap: 5px; flex-wrap: wrap; align-items: center;">
                                <a href="{{ url_for('lock_chimes.download_lock_chime', filename=chime.filename) }}" class="present-btn" style="text-decoration: none; padding: 6px 12px; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; line-height: 1.5; height: 34px; box-sizing: border-box;">‚¨áÔ∏è Download</a>
                                {% if chime.is_valid %}
                                <form method="post" action="{{ url_for('lock_chimes.set_as_chime', filename=chime.filename) }}" style="display: inline;" onsubmit="return handleSetChime(this);">
                                    <button type="submit" class="set-chime-btn" style="padding: 6px 12px; margin: 0; font-size: 14px; height: 34px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;">üîî Set as Active</button>
                                </form>
                                {% endif %}
                                <form method="post" action="{{ url_for('lock_chimes.delete_lock_chime', filename=chime.filename) }}" style="display: inline;" 
                                      onsubmit="return confirm('Are you sure you want to delete {{ chime.filename }}?');">
                                    <button type="submit" class="btn-delete" style="padding: 6px 12px; margin: 0; font-size: 14px; height: 34px; display: inline-flex; align-items: center; justify-content: center; box-sizing: border-box;">üóëÔ∏è Delete</button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Card Layout for Lock Chimes -->
    <div class="mobile-card-container">
        {% for chime in chime_files %}
        <div class="mobile-card" style="{% if not chime.is_valid %}border-left: 4px solid #f44336;{% endif %}">
            <div class="mobile-card-title">
                <strong>{{ chime.filename }}</strong>
            </div>
            <div class="mobile-card-info">
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Size:</span>
                    <span class="mobile-card-info-value">{{ chime.size_str }}</span>
                </div>
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Status:</span>
                    <span class="mobile-card-info-value">
                        {% if chime.is_valid %}
                        <span class="mobile-card-status valid">‚úì Valid</span>
                        {% else %}
                        <span class="mobile-card-status invalid" title="{{ chime.validation_msg }}">‚úó Invalid</span>
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="mobile-card-audio">
                <audio controls preload="none">
                    <source src="{{ url_for('lock_chimes.play_lock_chime', filename=chime.filename) }}?v={{ chime.mtime }}" type="audio/wav">
                </audio>
            </div>
            <div class="mobile-card-actions">
                <a href="{{ url_for('lock_chimes.download_lock_chime', filename=chime.filename) }}" class="present-btn">‚¨áÔ∏è Download</a>
                {% if chime.is_valid %}
                <form method="post" action="{{ url_for('lock_chimes.set_as_chime', filename=chime.filename) }}" onsubmit="return handleSetChime(this);">
                    <button type="submit" class="set-chime-btn">üîî Set as Active</button>
                </form>
                {% endif %}
                <form method="post" action="{{ url_for('lock_chimes.delete_lock_chime', filename=chime.filename) }}" 
                      onsubmit="return confirm('Are you sure you want to delete {{ chime.filename }}?');">
                    <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="info-box">
        <p>No chimes found in the Chimes library.</p>
        <p>Upload WAV files above to add them to your library.</p>
    </div>
    {% endif %}
</div>

<!-- Loading overlay for Set as Chime operation -->
<div id="chimeLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
    <div style="text-align: center; color: white;">
        <div class="spinner" style="border: 8px solid #f3f3f3; border-top: 8px solid #007bff; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
        <h3>Setting lock chime...</h3>
        <p>Please wait, this may take a few seconds</p>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
// Preserve scheduler section state across page loads
document.addEventListener('DOMContentLoaded', function() {
    const schedulerSection = document.getElementById('scheduler-section');
    const scheduleFormDetails = document.getElementById('schedule-form-details');
    
    // Check if there are any flash messages (indicates an action was just performed)
    const hasFlashMessages = document.querySelector('.flash-message') !== null;
    
    // Open scheduler section if:
    // 1. There are flash messages (user just performed an action)
    // 2. Session storage indicates it was previously open
    // 3. User manually opened it (tracked in session storage)
    const wasOpen = sessionStorage.getItem('schedulerSectionOpen') === 'true';
    
    if (hasFlashMessages || wasOpen) {
        schedulerSection.open = true;
        sessionStorage.setItem('schedulerSectionOpen', 'true');
    }
    
    // Track when user manually opens/closes the section
    schedulerSection.addEventListener('toggle', function() {
        sessionStorage.setItem('schedulerSectionOpen', schedulerSection.open ? 'true' : 'false');
    });
    
    // Similarly track the form details section
    if (scheduleFormDetails) {
        const formWasOpen = sessionStorage.getItem('scheduleFormOpen') === 'true';
        if (formWasOpen || hasFlashMessages) {
            scheduleFormDetails.open = true;
        }
        
        scheduleFormDetails.addEventListener('toggle', function() {
            sessionStorage.setItem('scheduleFormOpen', scheduleFormDetails.open ? 'true' : 'false');
        });
    }
});

function handleSetChime(form) {
    // Disable all Set as Active buttons
    const allChimeButtons = document.querySelectorAll('.set-chime-btn');
    allChimeButtons.forEach(btn => btn.disabled = true);
    
    // Show loading overlay
    document.getElementById('chimeLoadingOverlay').style.display = 'flex';
    
    return true;  // Allow form submission
}

// Handle schedule type switching
document.addEventListener('DOMContentLoaded', function() {
    const scheduleTypeRadios = document.querySelectorAll('.schedule-type-radio');
    const daysSelection = document.getElementById('days-selection');
    const dateSelection = document.getElementById('date-selection');
    const holidaySelection = document.getElementById('holiday-selection');
    const intervalSelection = document.getElementById('interval-selection');
    const timeSelection = document.getElementById('time-selection');
    const hourSelect = document.getElementById('hour-select');
    const minuteSelect = document.getElementById('minute-select');
    const ampmSelect = document.getElementById('ampm-select');
    const chimeSelect = document.getElementById('chime-select');
    
    function updateScheduleTypeFields() {
        const selectedType = document.querySelector('.schedule-type-radio:checked').value;
        
        // Hide all type-specific fields
        daysSelection.style.display = 'none';
        dateSelection.style.display = 'none';
        holidaySelection.style.display = 'none';
        intervalSelection.style.display = 'none';
        
        // Reset chime select to normal state
        chimeSelect.disabled = false;
        chimeSelect.style.pointerEvents = '';
        chimeSelect.style.opacity = '';
        chimeSelect.style.cursor = '';
        
        // Show relevant field and manage time selection/chime selection
        if (selectedType === 'weekly') {
            daysSelection.style.display = 'block';
            timeSelection.style.display = 'block';
            // Make time fields required
            hourSelect.required = true;
            minuteSelect.required = true;
            ampmSelect.required = true;
        } else if (selectedType === 'date') {
            dateSelection.style.display = 'block';
            timeSelection.style.display = 'block';
            // Make time fields required
            hourSelect.required = true;
            minuteSelect.required = true;
            ampmSelect.required = true;
        } else if (selectedType === 'holiday') {
            holidaySelection.style.display = 'block';
            // Hide time selection for holidays
            timeSelection.style.display = 'none';
            // Auto-set time to 12:00 AM and make fields not required
            hourSelect.value = '12';
            minuteSelect.value = '00';
            ampmSelect.value = 'AM';
            hourSelect.required = false;
            minuteSelect.required = false;
            ampmSelect.required = false;
        } else if (selectedType === 'recurring') {
            intervalSelection.style.display = 'block';
            // Hide time selection for recurring schedules
            timeSelection.style.display = 'none';
            // Force chime to RANDOM - don't disable so value submits
            chimeSelect.value = 'RANDOM';
            chimeSelect.style.pointerEvents = 'none';
            chimeSelect.style.opacity = '0.6';
            chimeSelect.style.cursor = 'not-allowed';
            hourSelect.required = false;
            minuteSelect.required = false;
            ampmSelect.required = false;
        }
    }
    
    // Add listeners to schedule type radios
    scheduleTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateScheduleTypeFields);
    });
    
    // Initialize on page load
    updateScheduleTypeFields();
});

// Handle recurring schedule confirmation for disabling other schedules
document.addEventListener('DOMContentLoaded', function() {
    const scheduleForm = document.getElementById('schedule-form');
    if (!scheduleForm) return;
    
    scheduleForm.addEventListener('submit', async function(e) {
        const scheduleType = document.querySelector('.schedule-type-radio:checked').value;
        const enabled = document.getElementById('enabled-checkbox').checked;
        const confirmField = scheduleForm.querySelector('input[name="confirm_disable_others"]');
        
        // Only intercept for enabled recurring schedules
        if (scheduleType === 'recurring' && enabled && (!confirmField || confirmField.value !== 'true')) {
            e.preventDefault();
            
            // Submit via AJAX to check if confirmation needed
            const formData = new FormData(scheduleForm);
            
            try {
                const response = await fetch(scheduleForm.action, {
                    method: 'POST',
                    body: formData
                });
                
                // Check if response is JSON (confirmation needed) or redirect (success)
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    
                    if (data.needs_confirmation) {
                        // Show confirmation dialog
                        const schedulesText = data.schedules_to_disable.map(s => `  ‚Ä¢ ${s.name}`).join('\n');
                        const confirmed = confirm(
                            `${data.message}\n\nSchedules that will be disabled:\n${schedulesText}`
                        );
                        
                        if (confirmed) {
                            // Add confirmation field and resubmit
                            const input = document.createElement('input');
                            input.type = 'hidden';
                            input.name = 'confirm_disable_others';
                            input.value = 'true';
                            scheduleForm.appendChild(input);
                            scheduleForm.submit();
                        }
                    }
                } else {
                    // Server returned HTML (redirect), reload to show result
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                // On error, reload to show any flash messages
                window.location.reload();
            }
        }
    });
});

// Handle chime upload with progress bar
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('chimeUploadForm');
    if (!form) return;
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('chime_file');
        const uploadBtn = document.getElementById('chimeUploadBtn');
        const progressDiv = document.getElementById('chimeUploadProgress');
        const progressBar = document.getElementById('chimeProgressBar');
        const statusText = document.getElementById('chimeUploadStatus');
        
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select a file to upload');
            return;
        }
        
        const file = fileInput.files[0];
        const formData = new FormData(form);
        
        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.textContent = '‚è≥ Uploading...';
        progressDiv.style.display = 'block';
        
        // Create AJAX request with progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
                statusText.textContent = `Uploading ${file.name}... (${(e.loaded / 1024).toFixed(1)} KB / ${(e.total / 1024).toFixed(1)} KB)`;
            }
        });
        
        // When upload finishes, show processing status
        xhr.upload.addEventListener('loadend', function() {
            if (xhr.readyState !== 4) {  // If request not complete yet
                progressBar.style.width = '100%';
                progressBar.textContent = 'üîÑ Processing...';
                progressBar.style.background = '#ffc107';
                statusText.textContent = 'Upload complete! Processing and validating file...';
                statusText.style.color = '#856404';
            }
        });
        
        // Handle completion
        xhr.addEventListener('load', function() {
            let response;
            try {
                response = JSON.parse(xhr.responseText);
            } catch (e) {
                response = null;
            }
            
            if (xhr.status === 200 && response && response.success) {
                progressBar.style.width = '100%';
                progressBar.textContent = '‚úì Complete';
                progressBar.style.background = '#28a745';
                
                // Show re-encoding info if present
                let successMsg = 'Upload complete!';
                if (response.reencoded && response.details) {
                    const details = response.details;
                    successMsg = `Upload successful! File was automatically re-encoded to ${details.strategy || 'Tesla format'} (${details.size_mb || '<1'} MB)`;
                }
                
                statusText.textContent = successMsg;
                statusText.style.color = '#28a745';
                
                // Redirect after short delay
                setTimeout(function() {
                    window.location.reload();
                }, 1000);
            } else {
                progressBar.style.background = '#dc3545';
                const errorMsg = response && response.error ? response.error : xhr.statusText || 'Upload failed';
                statusText.textContent = 'Upload failed: ' + errorMsg;
                statusText.style.color = '#dc3545';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üì§ Upload';
            }
        });
        
        // Handle errors
        xhr.addEventListener('error', function() {
            progressBar.style.background = '#dc3545';
            statusText.textContent = 'Upload failed: Network error';
            statusText.style.color = '#dc3545';
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'üì§ Upload';
        });
        
        // Send the request
        xhr.open('POST', form.action);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');  // Mark as AJAX request
        xhr.send(formData);
    });
});

// iOS Browser Detection and Warning Display
(function() {
    // Detect iOS device
    function isIOS() {
        return /(iPad|iPhone|iPod)/i.test(navigator.userAgent) && !window.MSStream;
    }
    
    // Detect Safari (true Safari, not other browsers using WebKit on iOS)
    function isSafari() {
        var ua = navigator.userAgent;
        // Safari should have "Safari" but NOT Chrome, CriOS, EdgiOS, FxiOS, OPiOS
        return /Safari/i.test(ua) && !/Chrome|CriOS|EdgiOS|FxiOS|OPiOS/i.test(ua);
    }
    
    // Show warning and hide controls if iOS + not Safari
    if (isIOS() && !isSafari()) {
        var warning = document.getElementById('iosWarning');
        var controls = document.getElementById('chimeUploadControls');
        if (warning) warning.style.display = 'block';
        if (controls) controls.style.display = 'none';
    }
})();

// Schedule edit functionality
async function editSchedule(scheduleId) {
    try {
        // Fetch schedule data
        const response = await fetch(`/lock_chimes/schedule/${scheduleId}/edit`);
        const data = await response.json();
        
        if (!data.success) {
            alert('Error loading schedule: ' + (data.error || 'Unknown error'));
            return;
        }
        
        const schedule = data.schedule;
        
        // Populate form fields
        document.getElementById('schedule-name').value = schedule.name;
        document.getElementById('chime-select').value = schedule.chime_filename;
        
        // Set schedule type
        const scheduleTypeRadio = document.querySelector(`.schedule-type-radio[value="${schedule.schedule_type}"]`);
        if (scheduleTypeRadio) {
            scheduleTypeRadio.checked = true;
            // Trigger change event to show appropriate fields
            scheduleTypeRadio.dispatchEvent(new Event('change'));
        }
        
        // Set time (12-hour format)
        if (schedule.hour_12 && schedule.minute && schedule.am_pm) {
            document.getElementById('hour-select').value = schedule.hour_12;
            document.getElementById('minute-select').value = schedule.minute;
            document.getElementById('ampm-select').value = schedule.am_pm;
        }
        
        // Set type-specific fields
        if (schedule.schedule_type === 'weekly') {
            // Clear all day checkboxes first
            document.querySelectorAll('.day-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            // Check selected days
            schedule.days.forEach(day => {
                const checkbox = document.getElementById('day-' + day);
                if (checkbox) checkbox.checked = true;
            });
        } else if (schedule.schedule_type === 'date') {
            document.getElementById('month-select').value = schedule.month;
            document.getElementById('day-select').value = schedule.day;
        } else if (schedule.schedule_type === 'holiday') {
            document.getElementById('holiday-select').value = schedule.holiday;
        } else if (schedule.schedule_type === 'recurring') {
            document.getElementById('interval-select').value = schedule.interval;
        }
        
        // Set enabled checkbox
        document.getElementById('enabled-checkbox').checked = schedule.enabled;
        
        // Change form to edit mode
        const form = document.getElementById('schedule-form');
        form.action = `/lock_chimes/schedule/${scheduleId}/edit`;
        form.dataset.editingId = scheduleId;
        
        // Update UI
        document.getElementById('form-title').textContent = '‚úèÔ∏è Edit Schedule';
        document.getElementById('submit-btn').textContent = 'üíæ Update Schedule';
        document.getElementById('cancel-btn').style.display = 'inline-block';
        
        // Open the form
        document.getElementById('schedule-form-details').open = true;
        
        // Scroll to form
        document.getElementById('schedule-form-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
    } catch (error) {
        console.error('Error loading schedule:', error);
        alert('Error loading schedule. Please try again.');
    }
}

function cancelEdit() {
    // Reset form
    const form = document.getElementById('schedule-form');
    form.reset();
    form.action = '{{ url_for("lock_chimes.add_schedule") }}';
    delete form.dataset.editingId;
    
    // Reset schedule type to weekly
    const weeklyRadio = document.querySelector('.schedule-type-radio[value="weekly"]');
    if (weeklyRadio) {
        weeklyRadio.checked = true;
        weeklyRadio.dispatchEvent(new Event('change'));
    }
    
    // Reset UI
    document.getElementById('form-title').textContent = '‚ûï Add New Schedule';
    document.getElementById('submit-btn').textContent = 'üíæ Save Schedule';
    document.getElementById('cancel-btn').style.display = 'none';
    
    // Close the form
    document.getElementById('schedule-form-details').open = false;
}
</script>

<style>
/* Rotate arrow when details is open */
details[open] > summary > span:first-child {
    transform: rotate(90deg);
    display: inline-block;
}

details > summary > span:first-child {
    transition: transform 0.2s;
    display: inline-block;
}

/* Remove default marker */
details > summary {
    list-style: none;
}

details > summary::-webkit-details-marker {
    display: none;
}
</style>
{% endblock %}
