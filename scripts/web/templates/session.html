{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üìπ Multi-Camera Session View</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    <div class="info-box">
        <strong>Session:</strong> {{ session_id }}<br>
        <strong>Folder:</strong> {{ folder }}<br>
        <strong>Cameras:</strong> {{ videos|length }} view(s)
    </div>
    
    <style>
    .focus-layout { display: flex; flex-direction: column; gap: 16px; }
    .focus-player { flex: 2; }
    .filmstrip { flex: 1; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; padding-right: 4px; overflow: visible; }
    .filmstrip-item { width: 100%; text-align: left; padding: 10px; border-radius: 8px; border: 1px solid #2f3a45; background: #1d2630; color: #eee; cursor: pointer; }
    .filmstrip-item:hover { border-color: #3ba3ff; background: #223040; }
    .film-thumb { height: 90px; border-radius: 6px; background: #0f161d; overflow: hidden; }
    .thumb-video { width: 100%; height: 100%; object-fit: cover; display: block; }
    .thumb-label { font-weight: 600; font-size: 14px; margin-top: 6px; }
    .thumb-meta { font-size: 12px; color: #9db3c7; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .active-thumb { border-color: #4caf50; box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2); }
    @media (min-width: 980px) {
        .focus-layout { flex-direction: row; align-items: flex-start; }
        .filmstrip { max-width: 360px; grid-template-columns: 1fr; }
    }
    </style>
    
<div class="focus-layout">
            <div class="focus-player">
                <div class="session-video-container">
                    <video id="mainVideo" controls preload="auto" poster="" playsinline>
                        Your browser does not support the video tag.
                    </video>
                    <div class="session-video-label" id="mainLabel">
                        üìπ Loading‚Ä¶
                        <span id="mainStatus" style="font-size: 11px; color: #666;"></span>
                    </div>
                </div>
                <div class="session-controls">
                    <button onclick="playMain()" class="present-btn">‚ñ∂Ô∏è Play</button>
                    <button onclick="pauseMain()" class="edit-btn">‚è∏Ô∏è Pause</button>
                    <button onclick="seekMain(0)" class="set-chime-btn">‚èÆÔ∏è Restart</button>
                    <button onclick="openFullVideo(currentVideo()?.name)" class="present-btn">‚ÜóÔ∏è Open in list</button>
                </div>
            </div>

            <div class="filmstrip" id="filmstrip">
                {# Front camera first, then the rest #}
                {% for video in videos if 'front' in video.camera|lower %}
                <button class="filmstrip-item" data-name="{{ video.name }}">
                    <div class="film-thumb">
                        <video class="thumb-video" muted playsinline preload="metadata" src="{{ url_for('videos.stream_video', folder=folder, filename=video.name) }}#t=0.1"></video>
                    </div>
                    <div class="thumb-label">{{ video.camera|replace('_', ' ')|title }}</div>
                    <div class="thumb-meta">{{ video.name }}</div>
                </button>
                {% endfor %}
                {% for video in videos if 'front' not in video.camera|lower %}
                <button class="filmstrip-item" data-name="{{ video.name }}">
                    <div class="film-thumb">
                        <video class="thumb-video" muted playsinline preload="metadata" src="{{ url_for('videos.stream_video', folder=folder, filename=video.name) }}#t=0.1"></video>
                    </div>
                    <div class="thumb-label">{{ video.camera|replace('_', ' ')|title }}</div>
                    <div class="thumb-meta">{{ video.name }}</div>
                </button>
                {% endfor %}
            </div>
        </div>
    
        <div style="text-align: center; margin-top: 20px;">
            <a href="{{ url_for('videos.file_browser', folder=folder) }}" class="btn-download">
                ‚Üê Back to Video List
            </a>
        </div>
    </div>

    <script id="videoListData" type="application/json">
    [
    {# Front first #}
    {% set comma = joiner() %}
    {% for video in videos if 'front' in video.camera|lower %}
    {{ comma() }}{
        "name": "{{ video.name }}",
        "camera": "{{ video.camera|replace('_', ' ')|title }}",
        "src": "{{ url_for('videos.stream_video', folder=folder, filename=video.name) }}"
    }
    {% endfor %}
    {% for video in videos if 'front' not in video.camera|lower %}
    {{ comma() }}{
        "name": "{{ video.name }}",
        "camera": "{{ video.camera|replace('_', ' ')|title }}",
        "src": "{{ url_for('videos.stream_video', folder=folder, filename=video.name) }}"
    }
    {% endfor %}
    ]
    </script>

    <script>
    // Focus + filmstrip: only one stream active; thumbs are lightweight buttons
    const videoList = JSON.parse(document.getElementById('videoListData').textContent);

    const mainVideo = document.getElementById('mainVideo');
    const mainLabel = document.getElementById('mainLabel');
    const mainStatus = document.getElementById('mainStatus');
    const filmstrip = document.getElementById('filmstrip');
    let currentIndex = 0;
    let userPaused = false;
    let retryHandle = null;

    function currentVideo() {
        return videoList[currentIndex];
    }

    function setStatus(text, color) {
        if (!mainStatus) return;
        mainStatus.textContent = text ? ` (${text})` : '';
        mainStatus.style.color = color || '#666';
    }

    function loadVideo(index, autoplay = false) {
        if (!videoList.length) return;
        currentIndex = index;
        const item = videoList[index];
        mainVideo.pause();
        mainVideo.src = item.src;
        mainVideo.currentTime = 0;
        mainLabel.innerHTML = `üìπ ${item.camera} <span style="font-size: 11px; color: #666;">${item.name}</span>`;
        setStatus('Loading‚Ä¶', '#2196f3');
        highlightActiveThumb(index);
        if (autoplay) {
            mainVideo.play().catch(() => {});
        }
    }

    function highlightActiveThumb(index) {
        const buttons = filmstrip.querySelectorAll('.filmstrip-item');
        buttons.forEach((btn, i) => {
            if (i === index) {
                btn.classList.add('active-thumb');
            } else {
                btn.classList.remove('active-thumb');
            }
        });
    }

    function playMain() {
        userPaused = false;
        mainVideo.play().catch(() => {});
    }

    function pauseMain() {
        userPaused = true;
        mainVideo.pause();
    }

    function seekMain(time) {
        mainVideo.currentTime = time;
    }

    function openFullVideo(filename) {
        if (!filename) return;
        window.location.href = "{{ url_for('videos.file_browser', folder=folder) }}&play=" + encodeURIComponent(filename);
    }

    function hasBufferedAhead(video, secondsAhead = 1.0) {
        if (!video.buffered || video.buffered.length === 0) return false;
        const t = video.currentTime;
        for (let i = 0; i < video.buffered.length; i++) {
            const start = video.buffered.start(i);
            const end = video.buffered.end(i);
            if (t >= start && t + secondsAhead <= end) {
                return true;
            }
        }
        return false;
    }

    function resumeIfBuffered() {
        if (userPaused || mainVideo.ended) return;
        if (hasBufferedAhead(mainVideo, 1.0)) {
            mainVideo.play().catch(() => {});
        }
    }

    // Wire filmstrip clicks (find index by name)
    filmstrip.addEventListener('click', (e) => {
        const btn = e.target.closest('.filmstrip-item');
        if (!btn) return;
        const name = btn.dataset.name;
        const idx = videoList.findIndex(v => v.name === name);
        if (idx >= 0) {
            loadVideo(idx, true);
        }
    });

    function clearRetry() {
        if (retryHandle) {
            clearTimeout(retryHandle);
            retryHandle = null;
        }
    }

    function nudgeCurrentTime(video) {
        // Small seek forward to poke the decoder when buffered data exists
        try {
            video.currentTime = Math.min(video.currentTime + 0.05, (video.duration || video.currentTime) - 0.01);
        } catch (_) {}
    }

    function ensurePlaying(delay = 250) {
        clearRetry();
        retryHandle = setTimeout(() => {
            if (userPaused || mainVideo.ended) return;
            if (hasBufferedAhead(mainVideo, 0.5)) {
                mainVideo.play().catch(() => {});
                nudgeCurrentTime(mainVideo);
            } else {
                // If nothing buffered yet, try again soon
                ensurePlaying(400);
            }
        }, delay);
    }

    // Status events
    mainVideo.addEventListener('playing', () => setStatus('Streaming‚Ä¶', '#4caf50'));
    mainVideo.addEventListener('waiting', () => {
        setStatus('Buffering‚Ä¶', '#ff9800');
        ensurePlaying(200);
    });
    mainVideo.addEventListener('stalled', () => {
        setStatus('Stalled, retrying‚Ä¶', '#f44336');
        ensurePlaying(200);
    });
    mainVideo.addEventListener('pause', () => {
        if (!userPaused && !mainVideo.ended) {
            ensurePlaying(150);
        }
    });
    mainVideo.addEventListener('canplay', () => setStatus('Ready', '#4caf50'));

    // Initialize first video
    if (videoList.length) {
        loadVideo(0, false);
    }
    </script>
    {% endblock %}
