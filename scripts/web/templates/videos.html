{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üìπ TeslaCam Event Browser</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>

    {% if not teslacam_available %}
    <div class="no-videos">
        <p><strong>TeslaCam folder is not accessible.</strong></p>
        <p>Make sure the system is in Present or Edit mode and the TeslaCam folder exists.</p>
    </div>
    {% elif folders %}
    <div class="folder-controls">
        <div class="folder-selector">
            <label for="folderSelect"><strong>Select Folder:</strong></label>
            <select id="folderSelect" onchange="loadFolder(this.value)">
                {% for folder in folders %}
                <option value="{{ folder.name }}" {% if folder.name == current_folder %}selected{% endif %}>
                    {{ folder.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Loading indicator for folder switch -->
    <div id="folder-loading" style="display: none; text-align: center; padding: 60px;">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div id="events-container">
    {% if events %}
    <div class="events-grid" id="eventsGrid">
        {% for event in events %}
        <div class="event-card" onclick="window.location.href='{{ url_for('videos.view_event', folder=current_folder, event_name=event.name) }}'">
            <div class="event-thumbnail">
                {% if event.has_thumbnail %}
                    {% if folder_structure == 'flat' %}
                    <img data-src="{{ url_for('videos.get_session_thumbnail', folder=current_folder, session_name=event.name) }}"
                         class="lazy-thumbnail"
                         alt="Session thumbnail"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         onerror="this.parentElement.innerHTML='<div class=\'event-thumbnail-placeholder\'><i class=\'bi bi-camera-video\' style=\'font-size: 3em;\'></i></div>';">
                    {% else %}
                    <img data-src="{{ url_for('videos.get_event_thumbnail', folder=current_folder, event_name=event.name) }}"
                         class="lazy-thumbnail"
                         alt="Event thumbnail"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         onerror="this.parentElement.innerHTML='<div class=\'event-thumbnail-placeholder\'><i class=\'bi bi-camera-video\' style=\'font-size: 3em;\'></i></div>';">
                    {% endif %}
                {% else %}
                <div class="event-thumbnail-placeholder">
                    <i class="bi bi-camera-video" style="font-size: 3em;"></i>
                </div>
                {% endif %}
            </div>
            <div class="event-info">
                <div class="event-datetime">{{ event.datetime }}</div>
                {% if event.city %}
                <div class="event-location">üìç {{ event.city }}</div>
                {% endif %}
                <div class="event-meta">
                    <span>üíæ {{ event.size_mb }} MB</span>
                    {% if event.reason %}
                    <span class="event-reason">{{ event.reason.replace('_', ' ').title() }}</span>
                    {% endif %}
                </div>
                <div class="event-cameras">
                    {% if event.camera_videos.front %}<span class="camera-badge">Front</span>{% endif %}
                    {% if event.camera_videos.back %}<span class="camera-badge">Back</span>{% endif %}
                    {% if event.camera_videos.left_repeater %}<span class="camera-badge">Left</span>{% endif %}
                    {% if event.camera_videos.right_repeater %}<span class="camera-badge">Right</span>{% endif %}
                    {% if event.camera_videos.left_pillar %}<span class="camera-badge">L-Pillar</span>{% endif %}
                    {% if event.camera_videos.right_pillar %}<span class="camera-badge">R-Pillar</span>{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Infinite Scroll Loading Indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- End of List Indicator -->
    <div id="end-of-list" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
        <p>No more videos</p>
    </div>

    {% else %}
    <div class="no-videos" id="no-videos-message">
        <p>No events found in {{ current_folder }}.</p>
    </div>
    {% endif %}
    </div>
    {% else %}
    <div class="no-videos">
        <p>No folders available in TeslaCam.</p>
    </div>
    {% endif %}
</div>

<style>
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.event-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
}

.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: var(--primary);
}

.event-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
}

.event-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease-in;
}

.event-thumbnail img.loaded {
    opacity: 1;
}

.event-thumbnail.loading::before {
    content: '';
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.event-thumbnail-placeholder {
    color: rgba(255,255,255,0.5);
}

.event-info {
    padding: 15px;
}

.event-datetime {
    font-weight: 600;
    font-size: 1.1em;
    color: var(--text);
    margin-bottom: 5px;
}

.event-location {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin-bottom: 8px;
}

.event-meta {
    display: flex;
    gap: 10px;
    font-size: 0.85em;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.event-reason {
    padding: 2px 8px;
    background: var(--primary-light);
    border-radius: 4px;
    font-size: 0.85em;
}

.event-cameras {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.camera-badge {
    padding: 3px 8px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75em;
    color: var(--text-secondary);
}

.no-videos {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.folder-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.folder-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.folder-selector select {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--bg-container);
    color: var(--text-primary);
    font-size: 1em;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 200px;
}

/* Dark mode specific styling */
[data-theme="dark"] .folder-selector select {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
    border-color: #30363d !important;
    /* Apply dark color scheme to the popup */
    color-scheme: dark;
}

/* Force dark appearance for select popup options */
[data-theme="dark"] .folder-selector select option {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
}

/* Webkit browsers need special handling */
@media (prefers-color-scheme: dark) {
    [data-theme="dark"] .folder-selector select {
        filter: none;
    }
}

.folder-selector select:hover {
    border-color: var(--btn-primary-bg);
}

.folder-selector select:focus {
    outline: none;
    border-color: var(--btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

@media (max-width: 768px) {
    .folder-selector select {
        min-width: 150px;
        font-size: 0.95em;
    }
}
</style>

<script>
// Video Browser - AJAX folder switching, infinite scroll, and thumbnail queue
(function() {
    'use strict';

    // State
    let currentFolder = "{{ current_folder or '' }}";
    let currentPage = {{ current_page|default(1) }};
    let hasNext = {{ 'true' if has_next else 'false' }};
    let folderStructure = "{{ folder_structure|default('events') }}";
    let isLoading = false;

    // DOM elements
    const eventsGrid = document.getElementById('eventsGrid');
    const eventsContainer = document.getElementById('events-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const folderLoading = document.getElementById('folder-loading');
    const endOfList = document.getElementById('end-of-list');
    const folderSelect = document.getElementById('folderSelect');

    // Thumbnail Queue System - limits concurrent loads to prevent CPU saturation
    const thumbnailQueue = {
        queue: [],
        processing: false,
        loadedSet: new Set(),
        activeRequests: new Map(),

        add(img) {
            if (!this.loadedSet.has(img) && !this.queue.includes(img)) {
                this.queue.push(img);
                this.process();
            }
        },

        clear() {
            // Cancel all active requests
            this.activeRequests.forEach((controller) => controller.abort());
            this.activeRequests.clear();
            this.queue.length = 0;
            this.processing = false;
            this.loadedSet.clear();
        },

        process() {
            if (this.processing || this.queue.length === 0) return;

            this.processing = true;
            const img = this.queue.shift();
            this.loadedSet.add(img);

            const src = img.dataset.src;
            if (!src) {
                this.processing = false;
                this.process();
                return;
            }

            const controller = new AbortController();
            this.activeRequests.set(img, controller);

            const container = img.closest('.event-thumbnail');
            if (container) container.classList.add('loading');

            fetch(src, { signal: controller.signal })
                .then(response => {
                    if (!response.ok) throw new Error('Failed');
                    return response.blob();
                })
                .then(blob => {
                    img.src = URL.createObjectURL(blob);
                    img.classList.add('loaded');
                })
                .catch(err => {
                    if (err.name !== 'AbortError' && img.onerror) {
                        img.onerror.call(img);
                    }
                })
                .finally(() => {
                    this.activeRequests.delete(img);
                    if (container) container.classList.remove('loading');
                    this.processing = false;
                    this.process();
                });
        }
    };

    // Intersection Observer for lazy loading thumbnails
    const thumbnailObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                thumbnailQueue.add(entry.target);
                thumbnailObserver.unobserve(entry.target);
            }
        });
    }, { rootMargin: '100px', threshold: 0.01 });

    // Observe all lazy thumbnails in a container
    function observeThumbnails(container) {
        container.querySelectorAll('.lazy-thumbnail').forEach(img => {
            if (!img.classList.contains('loaded')) {
                thumbnailObserver.observe(img);
            }
        });
    }

    // Create event card HTML
    function createEventCard(event) {
        const card = document.createElement('div');
        card.className = 'event-card';
        card.onclick = () => {
            thumbnailQueue.clear();
            window.location.href = `/videos/event/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`;
        };

        // Thumbnail
        let thumbnailHtml;
        if (event.has_thumbnail) {
            const thumbUrl = folderStructure === 'flat'
                ? `/videos/session_thumbnail/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`
                : `/videos/event_thumbnail/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`;
            thumbnailHtml = `<img data-src="${thumbUrl}" class="lazy-thumbnail" alt="Thumbnail"
                src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                onerror="this.parentElement.innerHTML='<div class=\\'event-thumbnail-placeholder\\'><i class=\\'bi bi-camera-video\\' style=\\'font-size: 3em;\\'></i></div>';">`;
        } else {
            thumbnailHtml = `<div class="event-thumbnail-placeholder"><i class="bi bi-camera-video" style="font-size: 3em;"></i></div>`;
        }

        // Camera badges (works with both full and compact camera_videos)
        const cams = event.camera_videos || {};
        let camerasHtml = '';
        if (cams.front) camerasHtml += '<span class="camera-badge">Front</span>';
        if (cams.back) camerasHtml += '<span class="camera-badge">Back</span>';
        if (cams.left_repeater) camerasHtml += '<span class="camera-badge">Left</span>';
        if (cams.right_repeater) camerasHtml += '<span class="camera-badge">Right</span>';
        if (cams.left_pillar) camerasHtml += '<span class="camera-badge">L-Pillar</span>';
        if (cams.right_pillar) camerasHtml += '<span class="camera-badge">R-Pillar</span>';

        card.innerHTML = `
            <div class="event-thumbnail">${thumbnailHtml}</div>
            <div class="event-info">
                <div class="event-datetime">${event.datetime}</div>
                ${event.city ? `<div class="event-location">üìç ${event.city}</div>` : ''}
                <div class="event-meta">
                    <span>üíæ ${event.size_mb} MB</span>
                    ${event.reason ? `<span class="event-reason">${event.reason.replace('_', ' ')}</span>` : ''}
                </div>
                <div class="event-cameras">${camerasHtml}</div>
            </div>`;

        return card;
    }

    // Load folder via AJAX (no full page reload)
    window.loadFolder = function(folderName) {
        if (isLoading || folderName === currentFolder) return;

        // Update URL without reload (for bookmarking/back button)
        const newUrl = `{{ url_for("videos.file_browser") }}?folder=${encodeURIComponent(folderName)}`;
        history.pushState({ folder: folderName }, '', newUrl);

        // Clear state and show loading
        thumbnailQueue.clear();
        isLoading = true;
        currentFolder = folderName;
        currentPage = 1;
        hasNext = false;

        // Show folder loading spinner, hide content
        if (folderLoading) folderLoading.style.display = 'block';
        if (eventsContainer) eventsContainer.style.display = 'none';
        if (endOfList) endOfList.style.display = 'none';

        // Fetch first page of new folder
        fetch(`{{ url_for("videos.file_browser") }}?folder=${encodeURIComponent(folderName)}&page=1`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            folderStructure = data.folder_structure || 'events';
            hasNext = data.has_next;
            currentPage = 1;

            // Rebuild events grid
            if (eventsContainer) {
                if (data.events && data.events.length > 0) {
                    // Create new grid
                    let grid = eventsContainer.querySelector('.events-grid');
                    if (!grid) {
                        grid = document.createElement('div');
                        grid.className = 'events-grid';
                        grid.id = 'eventsGrid';
                        // Clear and add grid
                        eventsContainer.innerHTML = '';
                        eventsContainer.appendChild(grid);
                        // Re-add loading indicators
                        const loadInd = document.createElement('div');
                        loadInd.id = 'loading-indicator';
                        loadInd.style.cssText = 'display: none; text-align: center; padding: 20px;';
                        loadInd.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
                        eventsContainer.appendChild(loadInd);
                        const endInd = document.createElement('div');
                        endInd.id = 'end-of-list';
                        endInd.style.cssText = 'display: none; text-align: center; padding: 20px; color: var(--text-muted);';
                        endInd.innerHTML = '<p>No more videos</p>';
                        eventsContainer.appendChild(endInd);
                    } else {
                        grid.innerHTML = '';
                    }

                    // Add event cards
                    data.events.forEach(event => {
                        grid.appendChild(createEventCard(event));
                    });

                    // Start observing thumbnails
                    observeThumbnails(grid);

                    // Show end indicator if no more
                    const endList = document.getElementById('end-of-list');
                    if (endList) endList.style.display = hasNext ? 'none' : 'block';
                } else {
                    // No events
                    eventsContainer.innerHTML = `<div class="no-videos" id="no-videos-message"><p>No events found in ${folderName}.</p></div>`;
                }
                eventsContainer.style.display = 'block';
            }
        })
        .catch(err => {
            console.error('Error loading folder:', err);
            if (eventsContainer) {
                eventsContainer.innerHTML = `<div class="no-videos"><p>Error loading folder. Please try again.</p></div>`;
                eventsContainer.style.display = 'block';
            }
        })
        .finally(() => {
            isLoading = false;
            if (folderLoading) folderLoading.style.display = 'none';
        });
    };

    // Handle browser back/forward
    window.addEventListener('popstate', function(e) {
        if (e.state && e.state.folder) {
            if (folderSelect) folderSelect.value = e.state.folder;
            loadFolder(e.state.folder);
        }
    });

    // Load more events (infinite scroll)
    function loadMoreEvents() {
        if (isLoading || !hasNext) return;

        isLoading = true;
        const loadInd = document.getElementById('loading-indicator');
        if (loadInd) loadInd.style.display = 'block';

        const nextPage = currentPage + 1;
        fetch(`{{ url_for("videos.file_browser") }}?folder=${encodeURIComponent(currentFolder)}&page=${nextPage}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.events && data.events.length > 0) {
                const grid = document.getElementById('eventsGrid');
                if (grid) {
                    data.events.forEach(event => {
                        grid.appendChild(createEventCard(event));
                    });
                    observeThumbnails(grid);
                }
                currentPage = data.next_page;
                hasNext = data.has_next;
            } else {
                hasNext = false;
            }

            const endList = document.getElementById('end-of-list');
            if (endList && !hasNext) endList.style.display = 'block';
        })
        .catch(err => console.error('Error loading more:', err))
        .finally(() => {
            isLoading = false;
            const loadInd = document.getElementById('loading-indicator');
            if (loadInd) loadInd.style.display = 'none';
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial history state
        if (currentFolder) {
            history.replaceState({ folder: currentFolder }, '', window.location.href);
        }

        // Observe initial thumbnails
        if (eventsGrid) {
            observeThumbnails(eventsGrid);
        }

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                loadMoreEvents();
            }
        });

        // Handle clicks on initial event cards (clear thumbnail queue before navigation)
        document.querySelectorAll('.event-card').forEach(card => {
            const originalOnclick = card.onclick;
            card.onclick = function(e) {
                thumbnailQueue.clear();
                if (originalOnclick) originalOnclick.call(this, e);
            };
        });
    });
})();
</script>
{% endblock %}
