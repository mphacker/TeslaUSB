{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üìπ TeslaCam Event Browser</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>

    {% if not teslacam_available %}
    <div class="no-videos">
        <p><strong>TeslaCam folder is not accessible.</strong></p>
        <p>Make sure the system is in Present or Edit mode and the TeslaCam folder exists.</p>
    </div>
    {% elif folders %}
    <div class="folder-controls">
        <div class="folder-selector">
            <label for="folderSelect"><strong>Select Folder:</strong></label>
            <select id="folderSelect" onchange="loadFolder(this.value)">
                {% for folder in folders %}
                <option value="{{ folder.name }}" {% if folder.name == current_folder %}selected{% endif %}>
                    {{ folder.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if events %}
    <div class="events-grid" id="eventsGrid">
        {% for event in events %}
        <div class="event-card" onclick="window.location.href='{{ url_for('videos.view_event', folder=current_folder, event_name=event.name) }}'">
            <div class="event-thumbnail">
                {% if event.has_thumbnail %}
                    {% if folder_structure == 'flat' %}
                    <img data-src="{{ url_for('videos.get_session_thumbnail', folder=current_folder, session_name=event.name) }}"
                         class="lazy-thumbnail"
                         alt="Session thumbnail"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         onerror="this.parentElement.innerHTML='<div class=\'event-thumbnail-placeholder\'><i class=\'bi bi-camera-video\' style=\'font-size: 3em;\'></i></div>';">
                    {% else %}
                    <img data-src="{{ url_for('videos.get_event_thumbnail', folder=current_folder, event_name=event.name) }}"
                         class="lazy-thumbnail"
                         alt="Event thumbnail"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         onerror="this.parentElement.innerHTML='<div class=\'event-thumbnail-placeholder\'><i class=\'bi bi-camera-video\' style=\'font-size: 3em;\'></i></div>';">
                    {% endif %}
                {% else %}
                <div class="event-thumbnail-placeholder">
                    <i class="bi bi-camera-video" style="font-size: 3em;"></i>
                </div>
                {% endif %}
            </div>
            <div class="event-info">
                <div class="event-datetime">{{ event.datetime }}</div>
                {% if event.city %}
                <div class="event-location">üìç {{ event.city }}</div>
                {% endif %}
                <div class="event-meta">
                    <span>üíæ {{ event.size_mb }} MB</span>
                    {% if event.reason %}
                    <span class="event-reason">{{ event.reason.replace('_', ' ').title() }}</span>
                    {% endif %}
                </div>
                <div class="event-cameras">
                    {% if event.camera_videos.front %}<span class="camera-badge">Front</span>{% endif %}
                    {% if event.camera_videos.back %}<span class="camera-badge">Back</span>{% endif %}
                    {% if event.camera_videos.left_repeater %}<span class="camera-badge">Left</span>{% endif %}
                    {% if event.camera_videos.right_repeater %}<span class="camera-badge">Right</span>{% endif %}
                    {% if event.camera_videos.left_pillar %}<span class="camera-badge">L-Pillar</span>{% endif %}
                    {% if event.camera_videos.right_pillar %}<span class="camera-badge">R-Pillar</span>{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Infinite Scroll Loading Indicator -->
    <div id="loading-indicator" style="display: none; text-align: center; padding: 20px;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- End of List Indicator -->
    <div id="end-of-list" style="display: none; text-align: center; padding: 20px; color: var(--text-muted);">
        <p>No more videos</p>
    </div>

    {% else %}
    <div class="no-videos">
        <p>No events found in {{ current_folder }}.</p>
    </div>
    {% endif %}
    {% else %}
    <div class="no-videos">
        <p>No folders available in TeslaCam.</p>
    </div>
    {% endif %}
</div>

<script>
// Infinite Scroll & Thumbnail Queue Implementation
document.addEventListener('DOMContentLoaded', function() {
    const eventsGrid = document.getElementById('eventsGrid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfList = document.getElementById('end-of-list');

    if (!eventsGrid) return;

    let currentPage = {{ current_page|default(1) }};
    let hasNext = {{ 'true' if has_next else 'false' }};
    let isLoading = false;
    const currentFolder = "{{ current_folder }}";

    // Thumbnail Queue System
    // Prioritizes visible thumbnails and loads them one by one to prevent CPU saturation
    const thumbnailQueue = {
        queue: [],
        processing: false,

        add: function(imgElement) {
            if (!this.queue.includes(imgElement)) {
                this.queue.push(imgElement);
                this.process();
            }
        },

        remove: function(imgElement) {
            const index = this.queue.indexOf(imgElement);
            if (index > -1) {
                this.queue.splice(index, 1);
            }
        },

        process: function() {
            if (this.processing || this.queue.length === 0) return;

            this.processing = true;
            const img = this.queue.shift(); // FIFO

            // Load the image
            const tempImage = new Image();
            tempImage.onload = () => {
                img.src = img.dataset.src;
                img.classList.add('loaded');
                this.processing = false;
                this.process(); // Process next
            };
            tempImage.onerror = () => {
                // Handle error (placeholder already set by onerror in HTML)
                this.processing = false;
                this.process(); // Process next
            };
            tempImage.src = img.dataset.src;
        }
    };

    // Intersection Observer for Lazy Loading Thumbnails
    const thumbnailObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (!img.classList.contains('loaded') && img.dataset.src) {
                    thumbnailQueue.add(img);
                }
            } else {
                // Optional: Remove from queue if scrolled out of view before loading
                // thumbnailQueue.remove(entry.target);
            }
        });
    }, {
        rootMargin: '50px 0px', // Preload slightly before viewport
        threshold: 0.1
    });

    // Observe existing thumbnails
    document.querySelectorAll('.lazy-thumbnail').forEach(img => {
        thumbnailObserver.observe(img);
    });

    // Infinite Scroll Logic
    window.addEventListener('scroll', () => {
        if (isLoading || !hasNext) return;

        // Check if near bottom of page
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadMoreEvents();
        }
    });

    function loadMoreEvents() {
        isLoading = true;
        loadingIndicator.style.display = 'block';

        const nextPage = currentPage + 1;
        const url = `{{ url_for('videos.file_browser') }}?folder=${encodeURIComponent(currentFolder)}&page=${nextPage}`;

        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.events && data.events.length > 0) {
                appendEvents(data.events, data.folder_structure);
                currentPage = data.next_page;
                hasNext = data.has_next;
            } else {
                hasNext = false;
            }

            if (!hasNext) {
                endOfList.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading more events:', error);
        })
        .finally(() => {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        });
    }

    function appendEvents(events, folderStructure) {
        events.forEach(event => {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.onclick = () => window.location.href = `/videos/event/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`;

            // Build Thumbnail HTML
            let thumbnailHtml = '';
            if (event.has_thumbnail) {
                const thumbUrl = folderStructure === 'flat'
                    ? `/videos/session_thumbnail/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`
                    : `/videos/event_thumbnail/${encodeURIComponent(currentFolder)}/${encodeURIComponent(event.name)}`;

                thumbnailHtml = `
                    <img data-src="${thumbUrl}"
                         class="lazy-thumbnail"
                         alt="Thumbnail"
                         src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                         onerror="this.parentElement.innerHTML='<div class=\\'event-thumbnail-placeholder\\'><i class=\\'bi bi-camera-video\\' style=\\'font-size: 3em;\\'></i></div>';">
                `;
            } else {
                thumbnailHtml = `
                    <div class="event-thumbnail-placeholder">
                        <i class="bi bi-camera-video" style="font-size: 3em;"></i>
                    </div>
                `;
            }

            // Build Cameras HTML
            let camerasHtml = '';
            const cams = event.camera_videos;
            if (cams.front) camerasHtml += '<span class="camera-badge">Front</span>';
            if (cams.back) camerasHtml += '<span class="camera-badge">Back</span>';
            if (cams.left_repeater) camerasHtml += '<span class="camera-badge">Left</span>';
            if (cams.right_repeater) camerasHtml += '<span class="camera-badge">Right</span>';
            if (cams.left_pillar) camerasHtml += '<span class="camera-badge">L-Pillar</span>';
            if (cams.right_pillar) camerasHtml += '<span class="camera-badge">R-Pillar</span>';

            // Build Reason HTML
            let reasonHtml = '';
            if (event.reason) {
                reasonHtml = `<span class="event-reason">${event.reason.replace('_', ' ')}</span>`;
            }

            // Build Location HTML
            let locationHtml = '';
            if (event.city) {
                locationHtml = `<div class="event-location">üìç ${event.city}</div>`;
            }

            card.innerHTML = `
                <div class="event-thumbnail">
                    ${thumbnailHtml}
                </div>
                <div class="event-info">
                    <div class="event-datetime">${event.datetime}</div>
                    ${locationHtml}
                    <div class="event-meta">
                        <span>üíæ ${event.size_mb} MB</span>
                        ${reasonHtml}
                    </div>
                    <div class="event-cameras">
                        ${camerasHtml}
                    </div>
                </div>
            `;

            eventsGrid.appendChild(card);

            // Observe new thumbnail
            const newImg = card.querySelector('.lazy-thumbnail');
            if (newImg) {
                thumbnailObserver.observe(newImg);
            }
        });
    }
});
</script>

<style>
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.event-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
}

.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: var(--primary);
}

.event-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
}

.event-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.3s ease-in;
}

.event-thumbnail img.loaded {
    opacity: 1;
}

.event-thumbnail.loading::before {
    content: '';
    position: absolute;
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.event-thumbnail-placeholder {
    color: rgba(255,255,255,0.5);
}

.event-info {
    padding: 15px;
}

.event-datetime {
    font-weight: 600;
    font-size: 1.1em;
    color: var(--text);
    margin-bottom: 5px;
}

.event-location {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin-bottom: 8px;
}

.event-meta {
    display: flex;
    gap: 10px;
    font-size: 0.85em;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.event-reason {
    padding: 2px 8px;
    background: var(--primary-light);
    border-radius: 4px;
    font-size: 0.85em;
}

.event-cameras {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.camera-badge {
    padding: 3px 8px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75em;
    color: var(--text-secondary);
}

.no-videos {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.folder-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.folder-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.folder-selector select {
    padding: 10px 16px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--bg-container);
    color: var(--text-primary);
    font-size: 1em;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 200px;
}

/* Dark mode specific styling */
[data-theme="dark"] .folder-selector select {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
    border-color: #30363d !important;
    /* Apply dark color scheme to the popup */
    color-scheme: dark;
}

/* Force dark appearance for select popup options */
[data-theme="dark"] .folder-selector select option {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
}

/* Webkit browsers need special handling */
@media (prefers-color-scheme: dark) {
    [data-theme="dark"] .folder-selector select {
        filter: none;
    }
}

.folder-selector select:hover {
    border-color: var(--btn-primary-bg);
}

.folder-selector select:focus {
    outline: none;
    border-color: var(--btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

@media (max-width: 768px) {
    .folder-selector select {
        min-width: 150px;
        font-size: 0.95em;
    }
}
</style>

<script>
function loadFolder(folderName) {
    window.location.href = '{{ url_for("videos.file_browser") }}?folder=' + encodeURIComponent(folderName);
}

// Progressive thumbnail loading with IntersectionObserver
// Optimized for Pi Zero 2 W performance
document.addEventListener('DOMContentLoaded', function() {
    const thumbnails = document.querySelectorAll('.event-thumbnail img[loading="lazy"]');

    if (thumbnails.length === 0) return;

    // Track loaded thumbnails to prevent duplicate loads
    const loadedThumbnails = new Set();

    // Track active fetch requests for cancellation
    const activeRequests = new Map(); // Map<img, AbortController>

    // Queue management: limit concurrent thumbnail loads to prevent overwhelming the Pi
    let concurrentLoads = 0;
    const MAX_CONCURRENT = 1; // Max 1 thumbnail at a time (Pi Zero 2 W has only 512MB RAM)
    const loadQueue = [];

    // Function to abort all pending thumbnail requests
    function abortAllThumbnails() {
        const startTime = performance.now();
        const activeCount = activeRequests.size;
        const queueCount = loadQueue.length;

        // Cancel all active fetch requests
        activeRequests.forEach((controller, img) => {
            controller.abort();
        });
        activeRequests.clear();

        // Clear the queue
        loadQueue.length = 0;
        concurrentLoads = 0;

        const elapsed = performance.now() - startTime;
        console.log(`Aborted ${activeCount} active thumbnails, cleared ${queueCount} queued (${elapsed.toFixed(1)}ms)`);
    }

    function processQueue() {
        while (concurrentLoads < MAX_CONCURRENT && loadQueue.length > 0) {
            const img = loadQueue.shift();
            if (loadedThumbnails.has(img)) continue;

            loadedThumbnails.add(img);
            concurrentLoads++;

            const originalSrc = img.dataset.src || img.src;
            const thumbnailContainer = img.closest('.event-thumbnail');

            // Add loading state
            if (thumbnailContainer) {
                thumbnailContainer.classList.add('loading');
            }

            // Create AbortController for this request
            const controller = new AbortController();
            activeRequests.set(img, controller);

            // Fetch thumbnail with abort support
            fetch(originalSrc, { signal: controller.signal })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to load');
                    return response.blob();
                })
                .then(blob => {
                    const objectUrl = URL.createObjectURL(blob);
                    img.src = objectUrl;
                    img.classList.add('loaded');
                    if (thumbnailContainer) {
                        thumbnailContainer.classList.remove('loading');
                    }
                })
                .catch(err => {
                    if (err.name === 'AbortError') {
                        // Silently handle abort
                        console.log('Thumbnail load cancelled');
                    } else {
                        // Trigger the onerror handler on error
                        if (img.onerror) {
                            img.onerror.call(img);
                        }
                        if (thumbnailContainer) {
                            thumbnailContainer.classList.remove('loading');
                        }
                    }
                })
                .finally(() => {
                    activeRequests.delete(img);
                    concurrentLoads--;
                    processQueue();
                });
        }
    }

    // Use IntersectionObserver for viewport-based loading
    // Only load thumbnails when they're about to enter the viewport
    const observerOptions = {
        root: null, // viewport
        rootMargin: '50px', // Start loading 50px before entering viewport
        threshold: 0.01 // Trigger when even 1% is visible
    };

    const observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (entry.isIntersecting) {
                const img = entry.target;

                // Add to queue if not already loaded
                if (!loadedThumbnails.has(img)) {
                    loadQueue.push(img);
                    processQueue();
                }

                // Stop observing once queued
                observer.unobserve(img);
            }
        });
    }, observerOptions);

    // Observe all lazy-loaded thumbnails
    thumbnails.forEach(function(img) {
        observer.observe(img);
    });

    // Cancel all thumbnail requests when user clicks on any event card (navigation)
    const eventCards = document.querySelectorAll('.event-card');
    eventCards.forEach(function(card) {
        card.addEventListener('click', function(e) {
            const clickTime = performance.now();
            console.log('üñ±Ô∏è Event card clicked');

            // Prevent immediate navigation
            e.preventDefault();
            e.stopImmediatePropagation();

            // Abort all thumbnails first
            const abortStart = performance.now();
            abortAllThumbnails();
            const abortTime = performance.now() - abortStart;
            console.log(`‚è±Ô∏è Abort completed in ${abortTime.toFixed(1)}ms`);

            // Small delay to ensure aborts are processed, then navigate
            setTimeout(function() {
                // Get the href from the onclick attribute
                const onclickAttr = card.getAttribute('onclick');
                if (onclickAttr) {
                    const match = onclickAttr.match(/window\.location\.href='([^']+)'/);
                    if (match) {
                        const totalTime = performance.now() - clickTime;
                        console.log(`üöÄ Navigating after ${totalTime.toFixed(1)}ms total delay`);
                        window.location.href = match[1];
                    }
                }
            }, 10); // 10ms delay to let aborts complete
        }, { capture: true }); // Capture phase to intercept before other handlers
    });

    // Cleanup on page unload to cancel pending requests
    window.addEventListener('beforeunload', function() {
        abortAllThumbnails();
        observer.disconnect();
    });
});
</script>
{% endblock %}
