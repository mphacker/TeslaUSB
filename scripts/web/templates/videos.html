{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üìπ TeslaCam Event Browser</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>

    {% if not teslacam_available %}
    <div class="no-videos">
        <p><strong>TeslaCam folder is not accessible.</strong></p>
        <p>Make sure the system is in Present or Edit mode and the TeslaCam folder exists.</p>
    </div>
    {% elif folders %}
    <div class="folder-controls">
        <div class="folder-selector">
            <label for="folderSelect"><strong>Select Folder:</strong></label>
            <select id="folderSelect" onchange="loadFolder(this.value)">
                {% for folder in folders %}
                <option value="{{ folder.name }}" {% if folder.name == current_folder %}selected{% endif %}>
                    {{ folder.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if events %}
    <div class="events-grid">
        {% for event in events %}
        <div class="event-card" onclick="window.location.href='{{ url_for('videos.view_event', folder=current_folder, event_name=event.name) }}'">
            <div class="event-thumbnail">
                {% if event.has_thumbnail %}
                    {% if folder_structure == 'flat' %}
                    <img src="{{ url_for('videos.get_session_thumbnail', folder=current_folder, session_name=event.name) }}"
                         alt="Session thumbnail"
                         loading="lazy"
                         onerror="this.parentElement.innerHTML='<div class=\'event-thumbnail-placeholder\'><i class=\'bi bi-camera-video\' style=\'font-size: 3em;\'></i></div>';">
                    {% else %}
                    <img src="{{ url_for('videos.get_event_thumbnail', folder=current_folder, event_name=event.name) }}" alt="Event thumbnail">
                    {% endif %}
                {% else %}
                <div class="event-thumbnail-placeholder">
                    <i class="bi bi-camera-video" style="font-size: 3em;"></i>
                </div>
                {% endif %}
            </div>
            <div class="event-info">
                <div class="event-datetime">{{ event.datetime }}</div>
                {% if event.city %}
                <div class="event-location">üìç {{ event.city }}</div>
                {% endif %}
                <div class="event-meta">
                    <span>üíæ {{ event.size_mb }} MB</span>
                    {% if event.reason %}
                    <span class="event-reason">{{ event.reason.replace('_', ' ').title() }}</span>
                    {% endif %}
                </div>
                <div class="event-cameras">
                    {% if event.camera_videos.front %}<span class="camera-badge">Front</span>{% endif %}
                    {% if event.camera_videos.back %}<span class="camera-badge">Back</span>{% endif %}
                    {% if event.camera_videos.left_repeater %}<span class="camera-badge">Left</span>{% endif %}
                    {% if event.camera_videos.right_repeater %}<span class="camera-badge">Right</span>{% endif %}
                    {% if event.camera_videos.left_pillar %}<span class="camera-badge">L-Pillar</span>{% endif %}
                    {% if event.camera_videos.right_pillar %}<span class="camera-badge">R-Pillar</span>{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-videos">
        <p>No events found in {{ current_folder }}.</p>
    </div>
    {% endif %}
    {% else %}
    <div class="no-videos">
        <p>No folders available in TeslaCam.</p>
    </div>
    {% endif %}
</div>

<style>
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.event-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
}

.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    border-color: var(--primary);
}

.event-thumbnail {
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.event-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.event-thumbnail-placeholder {
    color: rgba(255,255,255,0.5);
}

.event-info {
    padding: 15px;
}

.event-datetime {
    font-weight: 600;
    font-size: 1.1em;
    color: var(--text);
    margin-bottom: 5px;
}

.event-location {
    color: var(--text-secondary);
    font-size: 0.9em;
    margin-bottom: 8px;
}

.event-meta {
    display: flex;
    gap: 10px;
    font-size: 0.85em;
    color: var(--text-secondary);
    margin-bottom: 10px;
}

.event-reason {
    padding: 2px 8px;
    background: var(--primary-light);
    border-radius: 4px;
    font-size: 0.85em;
}

.event-cameras {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 10px;
}

.camera-badge {
    padding: 3px 8px;
    background: var(--surface-hover);
    border: 1px solid var(--border);
    border-radius: 4px;
    font-size: 0.75em;
    color: var(--text-secondary);
}

.no-videos {
    text-align: center;
    padding: 40px 20px;
    color: var(--text-secondary);
}

.folder-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 15px;
}

.folder-selector {
    display: flex;
    align-items: center;
    gap: 10px;
}

.folder-selector select {
    padding: 10px 16px;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background: var(--bg-container);
    color: var(--text-primary);
    font-size: 1em;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 200px;
}

/* Dark mode specific styling */
[data-theme="dark"] .folder-selector select {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
    border-color: #30363d !important;
    /* Apply dark color scheme to the popup */
    color-scheme: dark;
}

/* Force dark appearance for select popup options */
[data-theme="dark"] .folder-selector select option {
    background-color: #161b22 !important;
    color: #e6edf3 !important;
}

/* Webkit browsers need special handling */
@media (prefers-color-scheme: dark) {
    [data-theme="dark"] .folder-selector select {
        filter: none;
    }
}

.folder-selector select:hover {
    border-color: var(--btn-primary-bg);
}

.folder-selector select:focus {
    outline: none;
    border-color: var(--btn-primary-bg);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

@media (max-width: 768px) {
    .folder-selector select {
        min-width: 150px;
        font-size: 0.95em;
    }
}
</style>

<script>
function loadFolder(folderName) {
    window.location.href = '{{ url_for("videos.file_browser") }}?folder=' + encodeURIComponent(folderName);
}
</script>
{% endblock %}
