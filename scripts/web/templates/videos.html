{% extends "base.html" %}
{% block content %}
<div class="container">
    <h2>üìπ TeslaCam Video Browser</h2>
    <div class="status-label {{ mode_class }}">Current Mode: {{ mode_label }}</div>
    
    {% if not teslacam_available %}
    <div class="no-videos">
        <p><strong>TeslaCam folder is not accessible.</strong></p>
        <p>Make sure the system is in Present or Edit mode and the TeslaCam folder exists.</p>
    </div>
    {% elif folders %}
    <div class="folder-controls">
        <div class="folder-selector">
            <label for="folderSelect"><strong>Select Folder:</strong></label>
            <select id="folderSelect" onchange="loadFolder(this.value)">
                {% for folder in folders %}
                <option value="{{ folder.name }}" {% if folder.name == current_folder %}selected{% endif %}>
                    {{ folder.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% if mode_token == 'edit' and (videos or remaining_videos) %}
        <div class="delete-all-container">
            <form method="post" action="{{ url_for('videos.delete_all_videos', folder=current_folder) }}" 
                  onsubmit="return confirm('Are you sure you want to delete ALL {{ total_video_count }} videos in {{ current_folder }}? This cannot be undone!');" 
                  style="display: inline;">
                <button type="submit" class="btn-delete-all">üóëÔ∏è Delete All Videos</button>
            </form>
        </div>
        {% endif %}
    </div>
    
    <video id="videoPlayer" controls preload="none" playsinline></video>
    
    {% if videos %}
    <div class="video-table-container">
        <table class="video-table">
            <thead>
                <tr>
                    <th class="thumbnail-cell">Preview</th>
                    <th>Filename</th>
                    <th>Size</th>
                    <th>Modified</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for video in videos %}
                <tr>
                    <td class="thumbnail-cell">
                        <div class="thumbnail-container" 
                             data-folder="{{ current_folder }}" 
                             data-filename="{{ video.name }}">
                            <div class="thumbnail-spinner"></div>
                        </div>
                    </td>
                    <td>
                        <a href="#" class="video-name" onclick="playVideo('{{ video.name }}'); return false;">
                            {{ video.name }}
                        </a>
                        {% if video.session %}
                        <br><small style="color: #6c757d;">Session: {{ video.session }} | Camera: {{ video.camera }}</small>
                        {% endif %}
                    </td>
                    <td>{{ video.size_mb }} MB</td>
                    <td>{{ video.modified }}</td>
                    <td>
                        {% if video.session %}
                        <a href="{{ url_for('videos.view_session', folder=current_folder, session=video.session) }}" 
                           class="btn-session" 
                           title="View all cameras for this session">
                            üìπ Session
                        </a>
                        {% endif %}
                        <a href="{{ url_for('videos.download_video', folder=current_folder, filename=video.name) }}" 
                           class="btn-download" download>
                            ‚¨áÔ∏è Download
                        </a>
                        {% if mode_token == 'edit' %}
                        <form method="post" action="{{ url_for('videos.delete_video', folder=current_folder, filename=video.name) }}" 
                              onsubmit="return confirm('Are you sure you want to delete {{ video.name }}?');" 
                              style="display: inline;">
                            <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Mobile Card Layout -->
    <div class="mobile-card-container">
        {% for video in videos %}
        <div class="mobile-card">
            <div class="mobile-card-header">
                <div class="thumbnail-container mobile" 
                     data-folder="{{ current_folder }}" 
                     data-filename="{{ video.name }}">
                    <div class="thumbnail-spinner"></div>
                </div>
                <div class="mobile-card-title">
                    <a href="#" onclick="playVideo('{{ video.name }}'); return false;">
                        {{ video.name }}
                    </a>
                    {% if video.session %}
                    <div class="mobile-card-meta">Session: {{ video.session }} | Camera: {{ video.camera }}</div>
                    {% endif %}
                </div>
            </div>
            <div class="mobile-card-info">
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Size:</span>
                    <span class="mobile-card-info-value">{{ video.size_mb }} MB</span>
                </div>
                <div class="mobile-card-info-row">
                    <span class="mobile-card-info-label">Modified:</span>
                    <span class="mobile-card-info-value">{{ video.modified }}</span>
                </div>
            </div>
            <div class="mobile-card-actions">
                {% if video.session %}
                <a href="{{ url_for('videos.view_session', folder=current_folder, session=video.session) }}" 
                   class="btn-session" 
                   title="View all cameras for this session">
                    üìπ Session
                </a>
                {% endif %}
                <a href="{{ url_for('videos.download_video', folder=current_folder, filename=video.name) }}" 
                   class="btn-download" download>
                    ‚¨áÔ∏è Download
                </a>
                {% if mode_token == 'edit' %}
                <form method="post" action="{{ url_for('videos.delete_video', folder=current_folder, filename=video.name) }}" 
                      onsubmit="return confirm('Are you sure you want to delete {{ video.name }}?');" 
                      style="display: inline;">
                    <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
                </form>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="no-videos">
        <p>No videos found in this folder.</p>
    </div>
    {% endif %}
    {% else %}
    <div class="no-videos">
        <p>No TeslaCam folders found.</p>
    </div>
    {% endif %}
</div>

<!-- Loading indicator for infinite scroll -->
<div id="loadingIndicator" style="display: none; text-align: center; padding: 30px; margin: 20px 0;">
    <div style="display: inline-block;">
        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <p style="margin-top: 15px; color: #666; font-size: 14px;">Loading more videos...</p>
    </div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Thumbnail container styles */
.thumbnail-container {
    width: 80px;
    height: 45px;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    border-radius: 4px;
    overflow: hidden;
}

[data-theme="dark"] .thumbnail-container {
    background: #2a2a2a;
}

.thumbnail-container.mobile {
    width: 100px;
    height: 56px;
}

.thumbnail-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.thumbnail-spinner {
    border: 3px solid rgba(0, 0, 0, 0.1);
    border-top: 3px solid #007bff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 1s linear infinite;
}

[data-theme="dark"] .thumbnail-spinner {
    border: 3px solid rgba(255, 255, 255, 0.1);
    border-top: 3px solid #007bff;
}

.thumbnail-container.loaded .thumbnail-spinner {
    display: none;
}
</style>

<script>
// Remaining videos data for lazy loading
window.remainingVideos = {{ remaining_videos|tojson|safe }};
window.currentFolder = {{ current_folder|tojson|safe }};
window.modeToken = {{ mode_token|tojson|safe }};
const STREAM_URL_TEMPLATE = "{{ url_for('videos.stream_video', folder='__F__', filename='__V__') }}";
window.videosLoaded = false;
window.isLoading = false;
window.currentBatchIndex = 0;
const BATCH_SIZE = 15;

// Thumbnail loading queue management
const thumbnailQueue = [];
let isProcessingQueue = false;
let thumbnailsPaused = false; // Pause thumbnails during video playback

// Check queue - prevents too many simultaneous checks
const checkQueue = [];
let activeChecks = 0;
const MAX_CONCURRENT_CHECKS = 3; // Only check 3 thumbnails at a time

// Fetch abort controllers for cleanup
const abortControllers = [];

// Track all observers for cleanup
const intersectionObservers = [];

// Cleanup function for page unload
function cleanupThumbnailSystem() {
    console.log('üßπ Cleaning up thumbnail system...');
    
    // Abort all in-flight requests
    abortControllers.forEach(controller => {
        try {
            controller.abort();
        } catch (e) {}
    });
    abortControllers.length = 0;
    
    // Disconnect all observers
    intersectionObservers.forEach(observer => {
        try {
            observer.disconnect();
        } catch (e) {}
    });
    intersectionObservers.length = 0;
    
    // Clear queues
    checkQueue.length = 0;
    thumbnailQueue.length = 0;
    
    // Reset flags
    isProcessingQueue = false;
    activeChecks = 0;
    
    console.log('‚úì Cleanup complete');
}

// Queue a thumbnail check to prevent overwhelming the server
function queueThumbnailCheck(container) {
    // Don't queue if thumbnails are paused (video playing)
    if (thumbnailsPaused) {
        return;
    }
    checkQueue.push(container);
    processNextCheck();
}

// Process thumbnail checks with concurrency limit
async function processNextCheck() {
    // Pause processing if video is playing
    if (thumbnailsPaused || activeChecks >= MAX_CONCURRENT_CHECKS || checkQueue.length === 0) {
        return;
    }
    
    activeChecks++;
    const container = checkQueue.shift();
    
    await loadThumbnail(container);
    
    activeChecks--;
    
    // Process next check
    if (checkQueue.length > 0 && !thumbnailsPaused) {
        setTimeout(processNextCheck, 50);
    }
}

// Check if thumbnail exists and load it
async function loadThumbnail(container) {
    const folder = container.dataset.folder;
    const filename = container.dataset.filename;
    const thumbnailUrl = `/videos/thumbnail/${encodeURIComponent(folder)}/${encodeURIComponent(filename)}?instant=1`;
    
    // Create abort controller for this request
    const abortController = new AbortController();
    abortControllers.push(abortController);
    
    try {
        // Check if thumbnail exists (browser caches this GET request)
        const response = await fetch(thumbnailUrl, { 
            signal: abortController.signal 
        });
        
        if (response.ok) {
            // Thumbnail exists - use regular img src (browser serves from cache on next visit)
            console.log(`‚úì Loading cached thumbnail: ${filename}`);
            const img = document.createElement('img');
            img.src = thumbnailUrl;
            img.alt = 'Thumbnail';
            img.style.display = 'none'; // Hide until loaded to prevent broken image flash
            img.onload = () => {
                img.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(img);
                container.classList.add('loaded');
            };
            img.onerror = () => {
                console.warn(`‚úó Failed to load thumbnail: ${filename}`);
                // Keep spinner showing on error
            };
        } else if (response.status === 404) {
            // Thumbnail doesn't exist - add to generation queue
            console.log(`‚è≥ Queueing thumbnail generation: ${filename} (queue size: ${thumbnailQueue.length + 1})`);
            thumbnailQueue.push({ container, folder, filename, thumbnailUrl });
            processNextThumbnail();
        }
    } catch (error) {
        if (error.name === 'AbortError') {
            console.log(`‚èπÔ∏è Aborted check for ${filename}`);
        } else {
            console.error(`‚úó Error checking thumbnail for ${filename}:`, error);
            // On error, try to add to queue
            thumbnailQueue.push({ container, folder, filename, thumbnailUrl });
            processNextThumbnail();
        }
    } finally {
        // Remove from abort controllers
        const index = abortControllers.indexOf(abortController);
        if (index > -1) {
            abortControllers.splice(index, 1);
        }
    }
}

// Process thumbnail generation queue one at a time
async function processNextThumbnail() {
    // Pause processing if video is playing
    if (thumbnailsPaused || isProcessingQueue || thumbnailQueue.length === 0) {
        return;
    }
    
    isProcessingQueue = true;
    const item = thumbnailQueue.shift();
    
    console.log(`üîß Generating thumbnail: ${item.filename} (${thumbnailQueue.length} remaining in queue)`);
    
    try {
        // Request thumbnail generation
        const response = await fetch('/videos/api/generate_thumbnail', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                folder: item.folder,
                filename: item.filename
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            console.log(`‚úì Generated thumbnail: ${item.filename}`);
            // Thumbnail generated - display it (browser caches automatically)
            const img = document.createElement('img');
            img.src = item.thumbnailUrl;
            img.alt = 'Thumbnail';
            img.style.display = 'none'; // Hide until loaded
            img.onload = () => {
                img.style.display = 'block';
                item.container.innerHTML = '';
                item.container.appendChild(img);
                item.container.classList.add('loaded');
            };
            img.onerror = () => {
                console.warn(`‚úó Failed to display generated thumbnail: ${item.filename}`);
            };
        } else {
            console.warn(`‚úó Generation failed: ${item.filename}`);
        }
    } catch (error) {
        console.error(`‚úó Error generating thumbnail for ${item.filename}:`, error);
    }
    
    isProcessingQueue = false;
    
    // Process next item in queue (only if not paused)
    if (thumbnailQueue.length > 0 && !thumbnailsPaused) {
        setTimeout(processNextThumbnail, 100);
    } else if (thumbnailQueue.length === 0) {
        console.log('‚úì Thumbnail queue complete');
    }
}

// Initialize thumbnail loading for all visible containers
function initThumbnailLoading() {
    const containers = document.querySelectorAll('.thumbnail-container:not(.loaded)');
    console.log(`üì∏ Initializing thumbnail loading for ${containers.length} videos`);
    
    containers.forEach(container => {
        // Use Intersection Observer to only load visible thumbnails
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && !container.classList.contains('loaded')) {
                    // Queue the check instead of calling loadThumbnail directly
                    queueThumbnailCheck(container);
                    observer.unobserve(container);
                }
            });
        }, { rootMargin: '200px' });
        
        // Track observer for cleanup
        intersectionObservers.push(observer);
        observer.observe(container);
    });
}

function loadFolder(folderName) {
    window.location.href = "{{ url_for('videos.file_browser') }}?folder=" + encodeURIComponent(folderName);
}

function buildStreamUrl(folder, filename) {
    return STREAM_URL_TEMPLATE
        .replace('__F__', encodeURIComponent(folder))
        .replace('__V__', encodeURIComponent(filename));
}

function playVideo(filename) {
    const videoPlayer = document.getElementById('videoPlayer');
    const folder = document.getElementById('folderSelect').value;
    videoPlayer.src = buildStreamUrl(folder, filename);
    videoPlayer.style.display = 'block';
    videoPlayer.load();
    videoPlayer.play();
    videoPlayer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// Pause thumbnail generation when video is playing
function pauseThumbnailGeneration() {
    if (!thumbnailsPaused) {
        console.log('‚è∏Ô∏è Pausing thumbnail generation (video playing)');
        thumbnailsPaused = true;
    }
}

// Resume thumbnail generation when video stops
function resumeThumbnailGeneration() {
    if (thumbnailsPaused) {
        console.log('‚ñ∂Ô∏è Resuming thumbnail generation (video stopped)');
        thumbnailsPaused = false;
        // Kick off processing if there are items waiting
        if (checkQueue.length > 0) {
            processNextCheck();
        }
        if (thumbnailQueue.length > 0) {
            processNextThumbnail();
        }
    }
}

// Infinite scroll: Load more videos as user scrolls
function loadMoreVideos() {
    if (window.isLoading || !window.remainingVideos || window.remainingVideos.length === 0) {
        return;
    }
    
    const startIndex = window.currentBatchIndex;
    const endIndex = Math.min(startIndex + BATCH_SIZE, window.remainingVideos.length);
    const batch = window.remainingVideos.slice(startIndex, endIndex);
    
    if (batch.length === 0) {
        return;
    }
    
    window.isLoading = true;
    document.getElementById('loadingIndicator').style.display = 'block';
    
    // Small delay to show loading indicator (smoother UX)
    setTimeout(function() {
        // Render desktop table rows
        const tableBody = document.querySelector('.video-table-container tbody');
        if (tableBody) {
            batch.forEach(function(video) {
                const row = createTableRow(video);
                tableBody.appendChild(row);
            });
        }
        
        // Render mobile cards
        const mobileContainer = document.querySelector('.mobile-card-container');
        if (mobileContainer) {
            batch.forEach(function(video) {
                const card = createMobileCard(video);
                mobileContainer.appendChild(card);
            });
        }
        
        window.currentBatchIndex = endIndex;
        window.isLoading = false;
        document.getElementById('loadingIndicator').style.display = 'none';
        
        // Initialize thumbnail loading for newly added containers
        initThumbnailLoading();
        
        // If all videos loaded, mark as complete
        if (window.currentBatchIndex >= window.remainingVideos.length) {
            window.videosLoaded = true;
        }
    }, 100);
}

// Create table row for desktop view
function createTableRow(video) {
    const tr = document.createElement('tr');
    
    const sessionInfo = video.session ? 
        `<br><small style="color: #6c757d;">Session: ${escapeHtml(video.session)} | Camera: ${escapeHtml(video.camera)}</small>` : '';
    
    const sessionBtn = video.session ? 
        `<a href="/videos/session/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.session)}" 
            class="btn-session" title="View all cameras for this session">üìπ Session</a>` : '';
    
    const deleteBtn = window.modeToken === 'edit' ? 
        `<form method="post" action="/videos/delete/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.name)}" 
              onsubmit="return confirm('Are you sure you want to delete ${escapeHtml(video.name)}?');" 
              style="display: inline;">
            <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
        </form>` : '';
    
    tr.innerHTML = `
        <td class="thumbnail-cell">
            <div class="thumbnail-container" 
                 data-folder="${escapeHtml(window.currentFolder)}" 
                 data-filename="${escapeHtml(video.name)}">
                <div class="thumbnail-spinner"></div>
            </div>
        </td>
        <td>
            <a href="#" class="video-name" data-stream-url="${buildStreamUrl(window.currentFolder, video.name)}" onclick="playVideo('${escapeHtml(video.name)}'); return false;">
                ${escapeHtml(video.name)}
            </a>
            ${sessionInfo}
        </td>
        <td>${video.size_mb} MB</td>
        <td>${escapeHtml(video.modified)}</td>
        <td>
            ${sessionBtn}
            <a href="/videos/download/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.name)}" 
               class="btn-download" download>‚¨áÔ∏è Download</a>
            ${deleteBtn}
        </td>
    `;
    
    return tr;
}

// Create mobile card
function createMobileCard(video) {
    const div = document.createElement('div');
    div.className = 'mobile-card';
    
    const sessionInfo = video.session ? 
        `<div class="mobile-card-meta">Session: ${escapeHtml(video.session)} | Camera: ${escapeHtml(video.camera)}</div>` : '';
    
    const sessionBtn = video.session ? 
        `<a href="/videos/session/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.session)}" 
            class="btn-session" title="View all cameras for this session">üìπ Session</a>` : '';
    
    const deleteBtn = window.modeToken === 'edit' ? 
        `<form method="post" action="/videos/delete/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.name)}" 
              onsubmit="return confirm('Are you sure you want to delete ${escapeHtml(video.name)}?');" 
              style="display: inline;">
            <button type="submit" class="btn-delete">üóëÔ∏è Delete</button>
        </form>` : '';
    
    div.innerHTML = `
        <div class="mobile-card-header">
            <div class="thumbnail-container mobile" 
                 data-folder="${escapeHtml(window.currentFolder)}" 
                 data-filename="${escapeHtml(video.name)}">
                <div class="thumbnail-spinner"></div>
            </div>
            <div class="mobile-card-title">
                <a href="#" data-stream-url="${buildStreamUrl(window.currentFolder, video.name)}" onclick="playVideo('${escapeHtml(video.name)}'); return false;">
                    ${escapeHtml(video.name)}
                </a>
                ${sessionInfo}
            </div>
        </div>
        <div class="mobile-card-info">
            <div class="mobile-card-info-row">
                <span class="mobile-card-info-label">Size:</span>
                <span class="mobile-card-info-value">${video.size_mb} MB</span>
            </div>
            <div class="mobile-card-info-row">
                <span class="mobile-card-info-label">Modified:</span>
                <span class="mobile-card-info-value">${escapeHtml(video.modified)}</span>
            </div>
        </div>
        <div class="mobile-card-actions">
            ${sessionBtn}
            <a href="/videos/download/${encodeURIComponent(window.currentFolder)}/${encodeURIComponent(video.name)}" 
               class="btn-download" download>‚¨áÔ∏è Download</a>
            ${deleteBtn}
        </div>
    `;
    
    return div;
}

// HTML escape helper
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Scroll event handler with 85% trigger for page-level scrolling
function handleScroll() {
    if (window.videosLoaded) {
        return;
    }
    
    // Always use window scroll (page-level scrolling for both desktop and mobile)
    const scrollPosition = window.scrollY + window.innerHeight;
    const pageHeight = document.documentElement.scrollHeight;
    const scrollPercentage = (scrollPosition / pageHeight) * 100;
    
    // Trigger at 85% scroll
    if (scrollPercentage >= 85) {
        loadMoreVideos();
    }
}

// Debounce scroll events
let scrollTimeout;

// Auto-play video if 'play' parameter is in URL
window.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const videoToPlay = urlParams.get('play');
    if (videoToPlay) {
        // Small delay to ensure page is fully loaded
        setTimeout(function() {
            playVideo(videoToPlay);
        }, 300);
    }
    
    // Initialize thumbnail loading for initial page load
    initThumbnailLoading();
    
    // Add video player event listeners to pause/resume thumbnail generation
    const videoPlayer = document.getElementById('videoPlayer');
    if (videoPlayer) {
        // Pause thumbnails when video starts playing
        videoPlayer.addEventListener('play', pauseThumbnailGeneration);
        videoPlayer.addEventListener('playing', pauseThumbnailGeneration);
        
        // Resume thumbnails when video stops
        videoPlayer.addEventListener('pause', resumeThumbnailGeneration);
        videoPlayer.addEventListener('ended', resumeThumbnailGeneration);
        
        console.log('üé¨ Video player event listeners registered');
    }
    
    // Only enable infinite scroll if we have remaining videos (Videos page only)
    if (!window.remainingVideos || window.remainingVideos.length === 0) {
        return;
    }
    
    // Add scroll listener to window for infinite scroll (page-level scrolling)
    window.addEventListener('scroll', function() {
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }
        scrollTimeout = setTimeout(function() {
            handleScroll();
        }, 50);
    });
    
    // Initial check to load more if needed (in case initial content doesn't fill viewport)
    setTimeout(function() {
        handleScroll();
    }, 500);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    cleanupThumbnailSystem();
});

// Cleanup on navigation (for single-page apps)
window.addEventListener('pagehide', function() {
    cleanupThumbnailSystem();
});
</script>
{% endblock %}
